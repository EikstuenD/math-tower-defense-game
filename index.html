<!DOCTYPE html>
<html lang="no">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Matte-Forsvarerne 3.0</title>
    <style>
        :root {
            --primary: #2c3e50;
            --accent: #27ae60;
            --light: #ecf0f1;
            --danger: #e74c3c;
            --warning: #f39c12;
        }

        body {
            font-family: 'Segoe UI', Tahoma, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--primary);
            color: var(--light);
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100vh;
            overflow: hidden;
            user-select: none;
        }

        /* --- UI BAR --- */
        #ui-bar {
            width: 100%;
            background-color: rgba(0,0,0,0.5);
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 1.1rem;
            backdrop-filter: blur(5px);
            z-index: 10;
            box-sizing: border-box;
        }

        .stats-group span { margin-right: 15px; }
        
        .control-group button {
            padding: 5px 15px;
            margin-left: 5px;
            font-size: 0.9rem;
        }

        /* --- SPILLOMR√ÖDE --- */
        #game-wrapper {
            position: relative;
            margin-top: 10px;
            box-shadow: 0 0 30px rgba(0,0,0,0.5);
            border-radius: 8px;
            overflow: hidden;
            background: #000;
        }

        canvas {
            display: block;
            cursor: crosshair;
        }

        /* --- MENYER OG MODALER --- */
        .overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(44, 62, 80, 0.95);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
            transition: opacity 0.3s;
        }

        .hidden { display: none !important; }

        h1 { font-size: 3rem; margin-bottom: 10px; color: #f1c40f; text-shadow: 2px 2px #000; }
        h2 { color: #3498db; margin-top: 0; }
        h3 { color: #ecf0f1; border-bottom: 2px solid #7f8c8d; padding-bottom: 5px; }
        p { font-size: 1.1rem; max-width: 600px; text-align: center; }

        .btn {
            background: var(--accent);
            color: white;
            border: none;
            padding: 12px 25px;
            font-size: 1rem;
            border-radius: 8px;
            cursor: pointer;
            margin: 5px;
            transition: transform 0.1s, background 0.2s;
            box-shadow: 0 4px 0 rgba(0,0,0,0.2);
            font-weight: bold;
        }
        .btn:active { transform: translateY(4px); box-shadow: none; }
        .btn:hover { filter: brightness(1.1); }
        .btn-blue { background: #3498db; }
        .btn-red { background: var(--danger); }
        .btn-yellow { background: var(--warning); color: #2c3e50; }
        .btn-small { padding: 8px 15px; font-size: 0.9rem; }

        /* Startmeny valg */
        .selection-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        .section-title { margin-top: 20px; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 2px; color: #95a5a6; }

        /* T√•rnvalg meny (In-game) */
        #tower-select-menu, #tower-upgrade-menu {
            background: rgba(255,255,255,0.98);
            padding: 20px;
            border-radius: 15px;
            color: #333;
            text-align: center;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
        }
        .tower-option {
            display: inline-block;
            margin: 5px;
            cursor: pointer;
            padding: 10px;
            border: 2px solid transparent;
            border-radius: 10px;
            transition: 0.2s;
            background: #ecf0f1;
            width: 90px;
            vertical-align: top;
        }
        .tower-option:hover { background: #dfe6e9; border-color: #bdc3c7; transform: translateY(-3px); }
        .tower-icon { font-size: 2.5rem; display: block; margin-bottom: 5px; }
        .price-tag { display: block; font-weight: bold; color: #e67e22; }
        
        /* Mattevindu */
        #math-modal-content {
            background: white;
            color: #333;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            width: 350px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.6);
            position: relative;
        }
        #math-question { font-size: 2.5rem; font-weight: bold; margin: 15px 0; color: #2c3e50; }
        input[type="text"] {
            padding: 10px;
            font-size: 1.5rem;
            width: 70%;
            margin-bottom: 15px;
            border: 3px solid #bdc3c7;
            border-radius: 8px;
            text-align: center;
            outline: none;
        }
        input:focus { border-color: #3498db; }
        .hint-text { font-size: 0.9rem; color: #e74c3c; min-height: 1.2em; margin-bottom: 10px; font-weight: bold; }

    </style>
</head>
<body>

    <div id="ui-bar">
        <div class="stats-group">
            <span>‚ù§Ô∏è Liv: <span id="lives-display">20</span></span>
            <span>üåä B√∏lge: <span id="wave-display">1</span></span>
            <span>üí∞ Gull: <span id="gold-display">100</span></span>
            <span>üèÜ Rekord: <span id="highscore-display">0</span></span>
        </div>
        <div class="control-group">
            <button class="btn btn-yellow btn-small" onclick="togglePause()" id="pause-btn">Pause ‚è∏Ô∏è</button>
            <button class="btn btn-red btn-small" onclick="backToMenu()">Meny üè†</button>
        </div>
    </div>

    <div id="game-wrapper">
        <canvas id="gameCanvas" width="800" height="600"></canvas>

        <div id="start-screen" class="overlay">
            <h1>Matte-Forsvarerne 3.0</h1>
            
            <div class="section-title">1. Velg Kart</div>
            <div class="selection-grid" style="grid-template-columns: 1fr 1fr 1fr;">
                <button class="btn" onclick="selectMap('forest')">üå≤ Skogen<br><small>(Lett)</small></button>
                <button class="btn" onclick="selectMap('desert')">üåµ √òrkenen<br><small>(Middels)</small></button>
                <button class="btn" onclick="selectMap('volcano')">üåã Vulkanen<br><small>(Vanskelig)</small></button>
            </div>

            <div class="section-title">2. Velg Mattetema</div>
            <div class="selection-grid">
                <button class="btn btn-blue" onclick="setMathMode('add_sub')">Addisjon & Subtraksjon</button>
                <button class="btn btn-blue" onclick="setMathMode('mult_div')">Multiplikasjon & Divisjon</button>
                <button class="btn btn-blue" onclick="setMathMode('frac_add_sub')">Br√∏k (Pluss/Minus)</button>
                <button class="btn btn-blue" onclick="setMathMode('frac_mult_div')">Br√∏k (Gange/Dele)</button>
            </div>
            
            <button id="start-btn" class="btn btn-yellow" style="font-size: 1.5rem; padding: 15px 40px; margin-top: 20px;" disabled onclick="startGame()">START SPILL ‚ñ∂</button>
        </div>

        <div id="tower-select-overlay" class="overlay hidden" style="background: rgba(0,0,0,0.4);">
            <div id="tower-select-menu">
                <h3>Velg T√•rn</h3>
                <div class="tower-option" onclick="selectTowerType('normal')">
                    <span class="tower-icon">üèπ</span>
                    <b>Bue</b><br><span class="price-tag">50 G</span>
                </div>
                <div class="tower-option" onclick="selectTowerType('sniper')">
                    <span class="tower-icon">üî≠</span>
                    <b>Sniper</b><br><span class="price-tag">100 G</span>
                </div>
                <div class="tower-option" onclick="selectTowerType('rapid')">
                    <span class="tower-icon">‚öîÔ∏è</span>
                    <b>Rask</b><br><span class="price-tag">150 G</span>
                </div>
                <div class="tower-option" onclick="selectTowerType('ice')">
                    <span class="tower-icon">‚ùÑÔ∏è</span>
                    <b>Frost</b><br><span class="price-tag">125 G</span>
                </div>
                <br>
                <button class="btn btn-red btn-small" onclick="closeTowerMenu()">Avbryt</button>
            </div>
        </div>

        <div id="tower-upgrade-overlay" class="overlay hidden" style="background: rgba(0,0,0,0.4);">
            <div id="tower-upgrade-menu">
                <h3>Valg for T√•rn</h3>
                <p>Niv√•: <span id="selected-tower-level">1</span></p>
                <button class="btn btn-blue" onclick="initiateUpgrade()">
                    Oppgrader üÜô<br><small>Pris: <span id="upgrade-cost">0</span> G</small>
                </button>
                <button class="btn btn-red" onclick="sellTower()">
                    Selg üí∞<br><small>F√• tilbake: <span id="sell-value">0</span> G</small>
                </button>
                <br>
                <button class="btn btn-small" style="background:#95a5a6;" onclick="closeUpgradeMenu()">Lukk</button>
            </div>
        </div>

        <div id="math-overlay" class="overlay hidden" style="background: rgba(0,0,0,0.85);">
            <div id="math-modal-content">
                <h2 id="math-title">L√∏s oppgaven!</h2>
                <div id="math-question">...</div>
                <input type="text" id="math-answer" placeholder="Svar her..." autocomplete="off">
                <div class="hint-text" id="math-feedback"></div>
                <div style="display:flex; justify-content: center; gap: 10px;">
                    <button class="btn" onclick="checkAnswer()">Svar</button>
                    <button class="btn btn-yellow" onclick="buyHint()">Hint (-20G) üí°</button>
                </div>
                <button class="btn btn-small btn-red" style="margin-top:15px;" onclick="closeModal()">Avbryt</button>
                <p style="font-size: 0.8rem; margin-top:10px; color:#7f8c8d;">Tips: Br√∏k skrives som "1/2"</p>
            </div>
        </div>

        <div id="game-over-screen" class="overlay hidden">
            <h1>GAME OVER</h1>
            <p>Du n√•dde b√∏lge <span id="final-wave">0</span></p>
            <div style="display:flex;">
                <button class="btn btn-blue" onclick="restartGame()">Pr√∏v igjen üîÑ</button>
                <button class="btn btn-red" onclick="backToMenu()">Hovedmeny üè†</button>
            </div>
        </div>
        
        <div id="pause-screen" class="overlay hidden" style="background: rgba(0,0,0,0.3); backdrop-filter: blur(2px);">
            <h1 style="color: white;">PAUSE</h1>
            <button class="btn btn-yellow" onclick="togglePause()">Fortsett ‚ñ∂</button>
        </div>
    </div>

<script>
    /** --- KONFIGURASJON & VARIABLER --- **/
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    
    // Spilltilstand
    let gameState = 'MENU'; // MENU, PLAYING, PAUSED, MODAL, GAMEOVER
    let mathMode = null;
    let selectedMap = null;
    let lives = 20;
    let wave = 1;
    let gold = 100;
    let frameCount = 0;
    let highscore = localStorage.getItem('td_highscore') || 0;
    document.getElementById('highscore-display').innerText = highscore;

    // Objekter
    let towers = [];
    let enemies = [];
    let projectiles = [];
    let particles = [];

    // Kart Definisjoner
    const maps = {
        forest: {
            bg: '#27ae60', grid: '#2ecc71', pathColor: '#95a5a6',
            path: [{x:0, y:100}, {x:200, y:100}, {x:200, y:400}, {x:500, y:400}, {x:500, y:200}, {x:700, y:200}, {x:700, y:500}, {x:800, y:500}]
        },
        desert: {
            bg: '#f1c40f', grid: '#f39c12', pathColor: '#e67e22',
            path: [{x:0, y:50}, {x:100, y:50}, {x:100, y:500}, {x:300, y:500}, {x:300, y:100}, {x:600, y:100}, {x:600, y:400}, {x:800, y:400}]
        },
        volcano: {
            bg: '#c0392b', grid: '#e74c3c', pathColor: '#2c3e50',
            path: [{x:0, y:300}, {x:300, y:300}, {x:300, y:100}, {x:500, y:100}, {x:500, y:500}, {x:800, y:500}]
        }
    };
    let currentPath = [];

    // Logikk variabler
    let pendingBuildPos = null;
    let pendingTowerType = null;
    let selectedTower = null; // For upgrade/sell
    let currentMathAnswer = null;
    let audioCtx = null;

    /** --- MENY LOGIKK --- **/
    
    function selectMap(mapName) {
        selectedMap = mapName;
        highlightButton(event.target);
        checkStartReady();
    }

    function setMathMode(mode) {
        mathMode = mode;
        highlightButton(event.target);
        checkStartReady();
    }

    function highlightButton(btn) {
        // Fjern active klasse fra s√∏sken (enkel logikk)
        let siblings = btn.parentElement.children;
        for(let s of siblings) s.style.border = "none";
        btn.style.border = "4px solid #fff";
    }

    function checkStartReady() {
        document.getElementById('start-btn').disabled = !(selectedMap && mathMode);
    }

    function startGame() {
        resetGameVars();
        currentPath = maps[selectedMap].path;
        gameState = 'PLAYING';
        document.getElementById('start-screen').classList.add('hidden');
        initAudio();
        gameLoop();
    }

    function resetGameVars() {
        lives = (selectedMap === 'volcano') ? 10 : 20;
        gold = (selectedMap === 'forest') ? 150 : 100;
        wave = 1;
        frameCount = 0;
        towers = [];
        enemies = [];
        projectiles = [];
        particles = [];
    }
    
    function backToMenu() {
        if(!confirm("Er du sikker p√• at du vil avslutte til hovedmenyen?")) return;
        gameState = 'MENU';
        document.getElementById('game-over-screen').classList.add('hidden');
        document.getElementById('pause-screen').classList.add('hidden');
        document.getElementById('math-overlay').classList.add('hidden');
        document.getElementById('tower-select-overlay').classList.add('hidden');
        document.getElementById('tower-upgrade-overlay').classList.add('hidden');
        document.getElementById('start-screen').classList.remove('hidden');
    }
    
    function restartGame() {
        document.getElementById('game-over-screen').classList.add('hidden');
        startGame();
    }

    function togglePause() {
        if(gameState === 'PLAYING') {
            gameState = 'PAUSED';
            document.getElementById('pause-screen').classList.remove('hidden');
            document.getElementById('pause-btn').innerText = "Fortsett ‚ñ∂";
        } else if (gameState === 'PAUSED') {
            gameState = 'PLAYING';
            document.getElementById('pause-screen').classList.add('hidden');
            document.getElementById('pause-btn').innerText = "Pause ‚è∏Ô∏è";
            gameLoop();
        }
    }

    /** --- MATEMATIKK LOGIKK --- **/
    function generateQuestion() {
        let q = "", a = "";
        let n1, n2, d1, d2;
        const r = (max) => Math.floor(Math.random() * max) + 1;

        switch(mathMode) {
            case 'add_sub':
                n1 = r(20) + (wave * 2); n2 = r(20) + (wave * 2);
                if (Math.random() > 0.5) { q = `${n1} + ${n2}`; a = n1 + n2; } 
                else { if (n1 < n2) [n1, n2] = [n2, n1]; q = `${n1} - ${n2}`; a = n1 - n2; }
                break;
            case 'mult_div':
                n1 = r(9) + 1; n2 = r(9) + 1;
                if (Math.random() > 0.5) { q = `${n1} √ó ${n2}`; a = n1 * n2; } 
                else { let p = n1 * n2; q = `${p} : ${n1}`; a = n2; }
                break;
            case 'frac_add_sub':
                d1 = (r(4) + 1) * 2; n1 = r(d1 - 1); n2 = r(d1 - 1);
                if (Math.random() > 0.5) { q = `${n1}/${d1} + ${n2}/${d1}`; a = `${n1+n2}/${d1}`; } 
                else { if (n1 < n2) [n1, n2] = [n2, n1]; q = `${n1}/${d1} - ${n2}/${d1}`; a = `${n1-n2}/${d1}`; }
                break;
            case 'frac_mult_div':
                n1 = r(3); d1 = r(3)+1; n2 = r(3); d2 = r(3)+1;
                q = `${n1}/${d1} √ó ${n2}/${d2}`; a = `${n1*n2}/${d1*d2}`;
                break;
        }
        return { question: q, answer: a };
    }

    function checkAnswer() {
        const input = document.getElementById('math-answer');
        const feedback = document.getElementById('math-feedback');
        const userVal = input.value.trim();
        let isCorrect = false;

        if (String(currentMathAnswer).includes('/')) {
            if (!userVal.includes('/')) { isCorrect = (parseFloat(userVal) == eval(currentMathAnswer)); } 
            else {
                const [uN, uD] = userVal.split('/').map(Number);
                const [cN, cD] = currentMathAnswer.split('/').map(Number);
                if (uD && cD && (uN * cD === cN * uD)) isCorrect = true;
            }
        } else {
            if (parseInt(userVal) === parseInt(currentMathAnswer)) isCorrect = true;
        }

        if (isCorrect) {
            playSound('success');
            if (selectedTower) upgradeTowerAction(selectedTower);
            else buildTowerAction();
            closeModal();
        } else {
            playSound('error');
            input.style.borderColor = 'red';
            feedback.innerText = "Feil! Pr√∏v igjen.";
            setTimeout(() => { input.style.borderColor = '#bdc3c7'; }, 500);
        }
    }

    function buyHint() {
        if(gold >= 20) {
            gold -= 20;
            document.getElementById('gold-display').innerText = gold;
            document.getElementById('math-answer').value = currentMathAnswer;
            document.getElementById('math-feedback').innerText = "Hint kj√∏pt!";
        } else {
            document.getElementById('math-feedback').innerText = "Ikke nok gull!";
        }
    }

    /** --- SPILL LOOP --- **/

    function gameLoop() {
        if (gameState !== 'PLAYING') return;

        updateGame();
        drawGame();
        requestAnimationFrame(gameLoop);
    }

    function updateGame() {
        frameCount++;
        document.getElementById('lives-display').innerText = lives;
        document.getElementById('wave-display').innerText = wave;
        document.getElementById('gold-display').innerText = gold;

        // Spawn
        let spawnRate = Math.max(30, 100 - (wave * 4));
        if (frameCount % spawnRate === 0) spawnEnemy();
        
        // Wave
        if (frameCount % 1200 === 0) { wave++; playSound('levelup'); }

        // Towers
        towers.forEach(t => t.update());
        
        // Projectiles
        for (let i = projectiles.length - 1; i >= 0; i--) {
            projectiles[i].update();
            if (!projectiles[i].active) projectiles.splice(i, 1);
        }
        
        // Enemies
        for (let i = enemies.length - 1; i >= 0; i--) {
            let e = enemies[i];
            e.update();
            if (e.finished) {
                lives -= e.damage;
                enemies.splice(i, 1);
                playSound('hurt');
                if (lives <= 0) endGame();
            } else if (e.health <= 0) {
                gold += e.reward;
                createParticles(e.x, e.y, e.color);
                enemies.splice(i, 1);
                playSound('explosion');
            }
        }

        // Particles
        for (let i = particles.length - 1; i >= 0; i--) {
            particles[i].update();
            if (particles[i].life <= 0) particles.splice(i, 1);
        }
    }

    function spawnEnemy() {
        let type = 'normal';
        if (wave > 3 && Math.random() < 0.3) type = 'fast';
        if (wave > 5 && Math.random() < 0.2) type = 'tank';
        if (wave % 5 === 0 && Math.random() < 0.05) type = 'boss';
        enemies.push(new Enemy(type));
    }

    /** --- KLASSER (Oppdatert med Emojis) --- **/

    class Enemy {
        constructor(type) {
            this.pathIdx = 0;
            this.x = currentPath[0].x; this.y = currentPath[0].y;
            this.type = type; this.finished = false; this.frozen = 0;
            let hpMult = 1 + (wave * 0.4);
            
            if (type === 'normal') { this.speed=1.5; this.maxHp=20*hpMult; this.emoji='üëæ'; this.reward=5; this.damage=1; this.color='#8e44ad'; }
            if (type === 'fast')   { this.speed=3.0; this.maxHp=12*hpMult; this.emoji='ü¶á'; this.reward=8; this.damage=1; this.color='#e67e22'; }
            if (type === 'tank')   { this.speed=0.8; this.maxHp=60*hpMult; this.emoji='üêó'; this.reward=15; this.damage=2; this.color='#2c3e50'; }
            if (type === 'boss')   { this.speed=0.5; this.maxHp=300*hpMult; this.emoji='üëπ'; this.reward=100; this.damage=10; this.color='#c0392b'; }
            this.health = this.maxHp;
        }

        update() {
            let target = currentPath[this.pathIdx + 1];
            if (!target) { this.finished = true; return; }
            let spd = (this.frozen > 0) ? this.speed * 0.5 : this.speed;
            if(this.frozen > 0) this.frozen--;

            let dx = target.x - this.x; let dy = target.y - this.y;
            let dist = Math.hypot(dx, dy);

            if (dist < spd) { this.x = target.x; this.y = target.y; this.pathIdx++; }
            else { this.x += (dx/dist)*spd; this.y += (dy/dist)*spd; }
        }

        draw() {
            ctx.font = (this.type === 'boss') ? '40px Arial' : '24px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(this.emoji, this.x, this.y);

            // Helsebar
            let hpPct = this.health / this.maxHp;
            ctx.fillStyle = 'red'; ctx.fillRect(this.x - 10, this.y - 20, 20, 3);
            ctx.fillStyle = '#2ecc71'; ctx.fillRect(this.x - 10, this.y - 20, 20 * hpPct, 3);
            if(this.frozen > 0) { ctx.fillStyle='rgba(116, 185, 255, 0.5)'; ctx.beginPath(); ctx.arc(this.x,this.y,15,0,Math.PI*2); ctx.fill(); }
        }
    }

    class Tower {
        constructor(x, y, type) {
            this.x = x; this.y = y; this.type = type;
            this.level = 1; this.cooldown = 0;
            if (type === 'normal') { this.range=150; this.dmg=10; this.rate=40; this.emoji='üèπ'; }
            if (type === 'sniper') { this.range=300; this.dmg=50; this.rate=100; this.emoji='üî≠'; }
            if (type === 'rapid')  { this.range=120; this.dmg=4; this.rate=10; this.emoji='‚öîÔ∏è'; }
            if (type === 'ice')    { this.range=150; this.dmg=0; this.rate=60; this.emoji='‚ùÑÔ∏è'; }
        }

        update() {
            if (this.cooldown > 0) this.cooldown--;
            if (this.cooldown <= 0) {
                let target = null, minDst = Infinity;
                for (let e of enemies) {
                    let d = Math.hypot(e.x - this.x, e.y - this.y);
                    if (d <= this.range && d < minDst) { minDst = d; target = e; }
                }
                if (target) {
                    projectiles.push(new Projectile(this.x, this.y, target, this.type, this.dmg));
                    this.cooldown = this.rate;
                    playSound('shoot');
                }
            }
        }

        draw() {
            // Tegn rekkevidde ved hover? (Utelatt for ytelse i denne versjonen)
            ctx.font = '30px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(this.emoji, this.x, this.y);
            
            // Level stjerne
            ctx.fillStyle = '#f1c40f';
            ctx.font = '12px Arial';
            ctx.fillText("‚≠ê" + this.level, this.x + 15, this.y - 10);
        }
    }

    class Projectile {
        constructor(x, y, target, type, dmg) {
            this.x = x; this.y = y; this.target = target; this.type = type; this.dmg = dmg;
            this.speed = (type === 'sniper') ? 15 : 8; this.active = true;
        }
        update() {
            if (!this.target || this.target.health <= 0) { this.active = false; return; }
            let dx = this.target.x - this.x, dy = this.target.y - this.y;
            let dist = Math.hypot(dx, dy);
            if (dist < this.speed) {
                this.active = false;
                if (this.type === 'ice') this.target.frozen = 120;
                else this.target.health -= this.dmg;
            } else { this.x += (dx/dist)*this.speed; this.y += (dy/dist)*this.speed; }
        }
        draw() {
            ctx.fillStyle = (this.type === 'ice') ? '#74b9ff' : '#2c3e50';
            ctx.beginPath(); ctx.arc(this.x, this.y, 4, 0, Math.PI*2); ctx.fill();
        }
    }

    class Particle {
        constructor(x, y, color) {
            this.x=x; this.y=y; this.color=color; this.vx=(Math.random()-0.5)*5; this.vy=(Math.random()-0.5)*5; this.life=20;
        }
        update() { this.x+=this.vx; this.y+=this.vy; this.life--; }
    }
    function createParticles(x, y, color) { for(let i=0;i<8;i++) particles.push(new Particle(x,y,color)); }

    /** --- TEGNING --- **/
    function drawGame() {
        let map = maps[selectedMap];
        // Tegn bakgrunn med grid
        ctx.fillStyle = map.bg;
        ctx.fillRect(0,0, canvas.width, canvas.height);
        
        ctx.strokeStyle = map.grid;
        ctx.lineWidth = 1;
        ctx.beginPath();
        for(let i=0; i<800; i+=50) { ctx.moveTo(i,0); ctx.lineTo(i,600); }
        for(let i=0; i<600; i+=50) { ctx.moveTo(0,i); ctx.lineTo(800,i); }
        ctx.stroke();

        // Tegn sti
        ctx.strokeStyle = map.pathColor;
        ctx.lineWidth = 45;
        ctx.lineCap = 'round'; ctx.lineJoin = 'round';
        ctx.beginPath();
        ctx.moveTo(currentPath[0].x, currentPath[0].y);
        currentPath.forEach(p => ctx.lineTo(p.x, p.y));
        ctx.stroke();

        // Base
        let end = currentPath[currentPath.length-1];
        ctx.font = '40px Arial'; ctx.fillText("üè∞", end.x, end.y);

        // Objekter
        towers.forEach(t => t.draw());
        enemies.forEach(e => e.draw());
        projectiles.forEach(p => p.draw());
        particles.forEach(p => {
            ctx.fillStyle = p.color; ctx.globalAlpha = p.life/20;
            ctx.beginPath(); ctx.arc(p.x, p.y, 3, 0, Math.PI*2); ctx.fill(); ctx.globalAlpha = 1;
        });
    }

    /** --- INTERAKSJON --- **/
    canvas.addEventListener('mousedown', function(e) {
        if (gameState !== 'PLAYING') return;
        const rect = canvas.getBoundingClientRect();
        const mx = e.clientX - rect.left, my = e.clientY - rect.top;

        // Klikk p√• t√•rn?
        for (let t of towers) {
            if (Math.hypot(t.x - mx, t.y - my) < 25) {
                selectedTower = t;
                openUpgradeMenu();
                return;
            }
        }
        // Nytt t√•rn
        pendingBuildPos = {x: mx, y: my};
        document.getElementById('tower-select-overlay').classList.remove('hidden');
    });

    function selectTowerType(type) {
        let cost = {normal:50, sniper:100, rapid:150, ice:125}[type];
        if (gold < cost) { alert("Ikke nok gull!"); return; }
        pendingTowerType = type;
        closeTowerMenu();
        selectedTower = null; 
        openMathModal("Bygg T√•rn");
    }

    function openUpgradeMenu() {
        let t = selectedTower;
        let cost = 50 * t.level;
        let val = Math.floor((50 * t.level) / 2); // Enkel salgsverdi
        if(t.type=='sniper') val+=50; // Justering
        
        document.getElementById('selected-tower-level').innerText = t.level;
        document.getElementById('upgrade-cost').innerText = cost;
        document.getElementById('sell-value').innerText = val;
        document.getElementById('tower-upgrade-overlay').classList.remove('hidden');
    }

    function initiateUpgrade() {
        if (gold < 50 * selectedTower.level) { alert("Ikke nok gull!"); return; }
        closeUpgradeMenu();
        openMathModal("Oppgrader T√•rn");
    }

    function sellTower() {
        let idx = towers.indexOf(selectedTower);
        if(idx > -1) {
            gold += parseInt(document.getElementById('sell-value').innerText);
            towers.splice(idx, 1);
            playSound('success');
            closeUpgradeMenu();
        }
    }

    // Handlinger etter mattesvar
    function buildTowerAction() {
        let t = new Tower(pendingBuildPos.x, pendingBuildPos.y, pendingTowerType);
        towers.push(t);
        gold -= {normal:50, sniper:100, rapid:150, ice:125}[pendingTowerType];
    }
    function upgradeTowerAction(t) {
        gold -= (50 * t.level);
        t.level++;
        t.dmg *= 1.3; t.range *= 1.1;
    }

    /** --- UI HJELPERE --- **/
    function closeTowerMenu() { document.getElementById('tower-select-overlay').classList.add('hidden'); }
    function closeUpgradeMenu() { document.getElementById('tower-upgrade-overlay').classList.add('hidden'); }
    
    function openMathModal(title) {
        gameState = 'MODAL';
        document.getElementById('math-overlay').classList.remove('hidden');
        document.getElementById('math-title').innerText = title;
        document.getElementById('math-feedback').innerText = "";
        let qa = generateQuestion();
        document.getElementById('math-question').innerText = qa.question;
        currentMathAnswer = qa.answer;
        let input = document.getElementById('math-answer');
        input.value = ''; input.focus();
    }
    function closeModal() { document.getElementById('math-overlay').classList.add('hidden'); gameState = 'PLAYING'; gameLoop(); }
    
    document.getElementById('math-answer').addEventListener("keypress", function(e) { if (e.key === "Enter") checkAnswer(); });

    function endGame() {
        gameState = 'GAMEOVER';
        document.getElementById('game-over-screen').classList.remove('hidden');
        document.getElementById('final-wave').innerText = wave;
        if(wave > highscore) {
            highscore = wave;
            localStorage.setItem('td_highscore', highscore);
            document.getElementById('highscore-display').innerText = highscore;
        }
    }

    /** --- LYD --- **/
    function initAudio() { if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)(); }
    function playSound(type) {
        if (!audioCtx) return;
        const o = audioCtx.createOscillator(); const g = audioCtx.createGain();
        o.connect(g); g.connect(audioCtx.destination);
        const t = audioCtx.currentTime;
        if (type==='shoot') { o.frequency.setValueAtTime(600, t); o.frequency.exponentialRampToValueAtTime(100, t+0.1); g.gain.setValueAtTime(0.05, t); o.start(t); o.stop(t+0.1); }
        if (type==='explosion') { o.type='sawtooth'; o.frequency.setValueAtTime(100, t); o.frequency.exponentialRampToValueAtTime(10, t+0.3); g.gain.setValueAtTime(0.1, t); o.start(t); o.stop(t+0.3); }
        if (type==='success') { o.type='sine'; o.frequency.setValueAtTime(400, t); o.frequency.setValueAtTime(600, t+0.1); g.gain.setValueAtTime(0.1, t); o.start(t); o.stop(t+0.2); }
        if (type==='error') { o.type='square'; o.frequency.setValueAtTime(150, t); o.frequency.linearRampToValueAtTime(100, t+0.3); g.gain.setValueAtTime(0.1, t); o.start(t); o.stop(t+0.3); }
    }
</script>
</body>
</html>
