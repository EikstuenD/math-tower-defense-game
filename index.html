<!DOCTYPE html>
<html lang="no">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Matte-Forsvarerne: Retro Edition</title>
    <style>
        :root {
            --bg-color: #202028;
            --neon-green: #39ff14;
            --neon-pink: #ff00ff;
            --retro-gray: #bdc3c7;
            --ui-bg: #2c3e50;
        }

        body {
            font-family: 'Courier New', Courier, monospace; /* 90-talls font */
            margin: 0;
            padding: 0;
            background-color: #111;
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100vh;
            overflow: hidden;
            user-select: none;
        }

        /* --- CRT SCANLINE EFFECT --- */
        .scanlines {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(
                to bottom,
                rgba(255,255,255,0),
                rgba(255,255,255,0) 50%,
                rgba(0,0,0,0.2) 50%,
                rgba(0,0,0,0.2)
            );
            background-size: 100% 4px;
            pointer-events: none;
            z-index: 999;
            opacity: 0.6;
        }

        /* --- UI BAR --- */
        #ui-bar {
            width: 100%;
            background-color: #000;
            border-bottom: 4px solid var(--retro-gray);
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 1.1rem;
            font-weight: bold;
            z-index: 10;
            box-sizing: border-box;
            color: var(--neon-green);
            text-shadow: 0 0 5px var(--neon-green);
        }

        .control-group button {
            font-family: inherit;
            text-transform: uppercase;
            font-weight: bold;
        }

        /* --- SPILLOMR√ÖDE --- */
        #game-wrapper {
            position: relative;
            margin-top: 10px;
            box-shadow: 0 0 20px #000;
            border: 4px solid var(--retro-gray);
            background: #000;
        }

        canvas {
            display: block;
            cursor: crosshair;
            image-rendering: pixelated; /* Retro skarphet */
        }

        /* --- MENYER OG MODALER --- */
        .overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }

        .hidden { display: none !important; }

        h1 { 
            font-size: 2.5rem; 
            margin-bottom: 20px; 
            color: var(--neon-pink); 
            text-shadow: 3px 3px 0px #fff;
            text-transform: uppercase;
            letter-spacing: 3px;
        }
        
        h2 { color: #3498db; margin-top: 0; text-transform: uppercase; }
        
        /* RETRO KNAPPER */
        .btn {
            background: #7f8c8d;
            color: white;
            border: 4px outset #ecf0f1;
            padding: 10px 20px;
            font-size: 1rem;
            cursor: pointer;
            margin: 8px;
            font-family: inherit;
            font-weight: bold;
            text-transform: uppercase;
        }
        .btn:active { border-style: inset; transform: translateY(2px); }
        .btn:hover { background: #95a5a6; }
        .btn-blue { background: #2980b9; border-color: #3498db; }
        .btn-green { background: #27ae60; border-color: #2ecc71; }
        .btn-red { background: #c0392b; border-color: #e74c3c; }
        .btn-yellow { background: #f39c12; border-color: #f1c40f; color: black; }

        .selected-btn {
            background: var(--neon-pink) !important;
            border-color: #ffccff !important;
            box-shadow: 0 0 10px var(--neon-pink);
        }

        /* T√ÖRN MENY */
        #tower-select-menu, #tower-upgrade-menu {
            background: #000080; /* Windows 95 bl√• */
            border: 4px double #fff;
            padding: 20px;
            color: white;
            text-align: center;
            box-shadow: 10px 10px 0 #000;
        }
        
        .tower-option {
            display: inline-block;
            margin: 5px;
            cursor: pointer;
            padding: 10px;
            border: 2px dashed #bdc3c7;
            background: #2c3e50;
            width: 100px;
            vertical-align: top;
        }
        .tower-option:hover { background: #34495e; border-color: var(--neon-green); }
        .tower-icon { font-size: 2rem; display: block; margin-bottom: 5px; }
        .price-tag { display: block; font-weight: bold; color: var(--neon-green); margin-top:5px;}
        
        /* MATTE VINDU */
        #math-modal-content {
            background: #ecf0f1;
            border: 4px solid #2c3e50;
            color: black;
            padding: 20px;
            text-align: center;
            width: 380px;
            box-shadow: 15px 15px 0 rgba(0,0,0,0.8);
        }
        #math-header {
            background: #000080;
            color: white;
            margin: -20px -20px 20px -20px;
            padding: 10px;
            font-weight: bold;
        }
        #math-question { font-size: 2.2rem; font-weight: bold; margin: 15px 0; font-family: inherit; }
        
        input[type="text"] {
            padding: 10px;
            font-size: 1.5rem;
            width: 70%;
            margin-bottom: 15px;
            border: 3px inset #bdc3c7;
            background: #fff;
            text-align: center;
            font-family: inherit;
            color: black;
        }
    </style>
</head>
<body>

    <div class="scanlines"></div>

    <div id="ui-bar">
        <div class="stats-group">
            <span>‚ù§Ô∏è <span id="lives-display">20</span></span>
            <span>üåä <span id="wave-display">1</span></span>
            <span>üí∞ <span id="gold-display">100</span></span>
            <span>üèÜ <span id="highscore-display">0</span></span>
        </div>
        <div class="control-group">
            <button class="btn btn-yellow" onclick="togglePause()" id="pause-btn" style="padding: 5px 10px; font-size: 0.8rem;">||</button>
            <button class="btn btn-red" onclick="backToMenu()" style="padding: 5px 10px; font-size: 0.8rem;">X</button>
        </div>
    </div>

    <div id="game-wrapper">
        <canvas id="gameCanvas" width="800" height="600"></canvas>

        <div id="start-screen" class="overlay">
            <h1>Matte-Forsvarerne</h1>
            <p style="color:var(--neon-green)">INSERT COIN TO START...</p>
            
            <div style="display:flex; gap: 20px; margin-bottom: 20px;">
                <div style="text-align:center;">
                    <h3 style="color:#bdc3c7">VELG BRETT</h3>
                    <button class="btn" onclick="selectMap(this, 'forest')">üå≤ SKOG</button><br>
                    <button class="btn" onclick="selectMap(this, 'desert')">üåµ √òRKEN</button><br>
                    <button class="btn" onclick="selectMap(this, 'volcano')">üåã VULKAN</button>
                </div>
                <div style="text-align:center;">
                    <h3 style="color:#bdc3c7">VELG REGNEART</h3>
                    <button class="btn" onclick="setMathMode(this, 'add_sub')">PLUSS / MINUS</button><br>
                    <button class="btn" onclick="setMathMode(this, 'mult_div')">GANGE / DELE</button><br>
                    <button class="btn" onclick="setMathMode(this, 'frac_add_sub')">BR√òK (+/-)</button><br>
                    <button class="btn" onclick="setMathMode(this, 'frac_mult_div')">BR√òK (* / :)</button>
                </div>
            </div>
            
            <button id="start-btn" class="btn btn-green" style="font-size: 1.5rem; padding: 15px 50px;" disabled onclick="startGame()">START SPILLET</button>
        </div>

        <div id="tower-select-overlay" class="overlay hidden" style="background: rgba(0,0,0,0.6);">
            <div id="tower-select-menu">
                <h3 style="margin-top:0; border-bottom: 2px solid white; padding-bottom:10px;">VELG FORSVAR</h3>
                <div class="tower-option" onclick="selectTowerType('normal')">
                    <span class="tower-icon">üèπ</span>
                    <b>BUE</b><br><span class="price-tag" style="color: #fff;">GRATIS</span>
                </div>
                <div class="tower-option" onclick="selectTowerType('sniper')">
                    <span class="tower-icon">üî≠</span>
                    <b>SNIPER</b><br><span class="price-tag">100 G</span>
                </div>
                <div class="tower-option" onclick="selectTowerType('rapid')">
                    <span class="tower-icon">‚öîÔ∏è</span>
                    <b>RASK</b><br><span class="price-tag">150 G</span>
                </div>
                <div class="tower-option" onclick="selectTowerType('ice')">
                    <span class="tower-icon">‚ùÑÔ∏è</span>
                    <b>FROST</b><br><span class="price-tag">125 G</span>
                </div>
                <br>
                <button class="btn btn-red" onclick="closeTowerMenu()">AVBRYT</button>
            </div>
        </div>

        <div id="tower-upgrade-overlay" class="overlay hidden" style="background: rgba(0,0,0,0.6);">
            <div id="tower-upgrade-menu">
                <h3>T√ÖRN MENY</h3>
                <p>NIV√Ö: <span id="selected-tower-level" style="color:var(--neon-green)">1</span></p>
                <button class="btn btn-blue" onclick="initiateUpgrade()">
                    OPPGRADER ‚¨ÜÔ∏è<br><small>PRIS: <span id="upgrade-cost">0</span> G</small>
                </button>
                <button class="btn btn-red" onclick="sellTower()">
                    SELG üí∏<br><small>VERDI: <span id="sell-value">0</span> G</small>
                </button>
                <br>
                <button class="btn" onclick="closeUpgradeMenu()">LUKK</button>
            </div>
        </div>

        <div id="math-overlay" class="overlay hidden">
            <div id="math-modal-content">
                <div id="math-header">MATTE-OPPGAVE</div>
                <div id="math-question">...</div>
                <input type="text" id="math-answer" placeholder="?" autocomplete="off">
                <div class="hint-text" id="math-feedback" style="color: red; min-height: 20px;"></div>
                <div>
                    <button class="btn btn-green" onclick="checkAnswer()">SVAR ‚Üµ</button>
                    <button class="btn btn-yellow" onclick="buyHint()">HINT (20G)</button>
                </div>
                <button class="btn btn-red" style="margin-top:10px; font-size: 0.8rem;" onclick="closeModal()">AVBRYT</button>
            </div>
        </div>

        <div id="game-over-screen" class="overlay hidden">
            <h1 style="color: red;">GAME OVER</h1>
            <p>B√òLGE N√ÖDD: <span id="final-wave" style="color: white; font-size: 2rem;">0</span></p>
            <div>
                <button class="btn btn-green" onclick="restartGame()">PR√òV IGJEN</button>
                <button class="btn btn-red" onclick="backToMenu()">MENY</button>
            </div>
        </div>
        
        <div id="pause-screen" class="overlay hidden">
            <h1 style="color: yellow; text-shadow: 4px 4px 0 #000;">PAUSE</h1>
            <button class="btn btn-green" onclick="togglePause()">FORTSETT</button>
        </div>
    </div>

<script>
    /** --- KONFIGURASJON --- **/
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    
    // Global tilstand
    let gameState = 'MENU';
    let mathMode = null;
    let selectedMap = null;
    let lives = 20;
    let wave = 1;
    let gold = 100;
    let frameCount = 0;
    let highscore = localStorage.getItem('td_highscore_v4') || 0;
    document.getElementById('highscore-display').innerText = highscore;

    // Cache for bakgrunnsbilde (ytelse)
    let mapBackgroundImage = null;

    // Entiteter
    let towers = [];
    let enemies = [];
    let projectiles = [];
    let particles = [];

    const maps = {
        forest: {
            // Skog: Gr√∏nt med m√∏rkegr√∏nne flekker
            baseColor: '#27ae60', noiseColor: '#1e8449',
            pathColor: '#7f8c8d', 
            path: [{x:0, y:100}, {x:200, y:100}, {x:200, y:400}, {x:500, y:400}, {x:500, y:200}, {x:700, y:200}, {x:700, y:500}, {x:800, y:500}]
        },
        desert: {
            // √òrken: Gul med oransje sandkorn
            baseColor: '#f1c40f', noiseColor: '#d35400',
            pathColor: '#e67e22',
            path: [{x:0, y:50}, {x:100, y:50}, {x:100, y:500}, {x:300, y:500}, {x:300, y:100}, {x:600, y:100}, {x:600, y:400}, {x:800, y:400}]
        },
        volcano: {
            // Vulkan: M√∏rkegr√• med r√∏de gl√∏r
            baseColor: '#2c3e50', noiseColor: '#c0392b',
            pathColor: '#111',
            path: [{x:0, y:300}, {x:300, y:300}, {x:300, y:100}, {x:500, y:100}, {x:500, y:500}, {x:800, y:500}]
        }
    };
    let currentPath = [];

    let pendingBuildPos = null;
    let pendingTowerType = null;
    let selectedTower = null;
    let currentMathAnswer = null;
    let audioCtx = null;

    /** --- GRAFIKK MOTOR (BAKGRUNN) --- **/
    function generateMapTexture(mapData) {
        // Lager et "usynlig" lerret for √• tegne bakgrunnen √©n gang
        const offCanvas = document.createElement('canvas');
        offCanvas.width = 800;
        offCanvas.height = 600;
        const oCtx = offCanvas.getContext('2d');

        // 1. Base farge
        oCtx.fillStyle = mapData.baseColor;
        oCtx.fillRect(0, 0, 800, 600);

        // 2. Tegn 10,000 tilfeldige prikker for tekstur (sand/gress/aske)
        oCtx.fillStyle = mapData.noiseColor;
        for (let i = 0; i < 15000; i++) {
            let x = Math.random() * 800;
            let y = Math.random() * 600;
            let size = Math.random() * 3 + 1;
            oCtx.fillRect(x, y, size, size);
        }

        // 3. Rutenett (Grid) over det hele
        oCtx.strokeStyle = 'rgba(0,0,0,0.1)';
        oCtx.lineWidth = 1;
        oCtx.beginPath();
        for(let i=0; i<800; i+=50) { oCtx.moveTo(i,0); oCtx.lineTo(i,600); }
        for(let i=0; i<600; i+=50) { oCtx.moveTo(0,i); oCtx.lineTo(800,i); }
        oCtx.stroke();

        // 4. Tegn veien
        oCtx.lineCap = 'round';
        oCtx.lineJoin = 'round';
        
        // Veikant (Shadow)
        oCtx.strokeStyle = 'rgba(0,0,0,0.3)';
        oCtx.lineWidth = 55;
        oCtx.beginPath();
        oCtx.moveTo(mapData.path[0].x, mapData.path[0].y + 5);
        mapData.path.forEach(p => oCtx.lineTo(p.x, p.y + 5));
        oCtx.stroke();

        // Selve veien
        oCtx.strokeStyle = mapData.pathColor;
        oCtx.lineWidth = 45;
        oCtx.beginPath();
        oCtx.moveTo(mapData.path[0].x, mapData.path[0].y);
        mapData.path.forEach(p => oCtx.lineTo(p.x, p.y));
        oCtx.stroke();

        return offCanvas;
    }

    /** --- SPILL LOGIKK --- **/
    function selectMap(btn, mapName) {
        selectedMap = mapName;
        // Reset buttons styling
        let p = btn.parentElement;
        for(let child of p.children) if(child.tagName === 'BUTTON') child.classList.remove('selected-btn');
        btn.classList.add('selected-btn');
        checkStartReady();
    }

    function setMathMode(btn, mode) {
        mathMode = mode;
        let p = btn.parentElement;
        for(let child of p.children) if(child.tagName === 'BUTTON') child.classList.remove('selected-btn');
        btn.classList.add('selected-btn');
        checkStartReady();
    }

    function checkStartReady() {
        document.getElementById('start-btn').disabled = !(selectedMap && mathMode);
    }

    function startGame() {
        lives = (selectedMap === 'volcano') ? 10 : 20;
        gold = (selectedMap === 'forest') ? 150 : 100;
        wave = 1;
        frameCount = 0;
        towers = [];
        enemies = [];
        projectiles = [];
        particles = [];
        currentPath = maps[selectedMap].path;
        
        // Generer bakgrunn
        mapBackgroundImage = generateMapTexture(maps[selectedMap]);

        gameState = 'PLAYING';
        document.getElementById('start-screen').classList.add('hidden');
        initAudio();
        gameLoop();
    }
    
    function backToMenu() {
        if(!confirm("Avslutte til meny?")) return;
        gameState = 'MENU';
        document.getElementById('game-over-screen').classList.add('hidden');
        document.getElementById('pause-screen').classList.add('hidden');
        document.getElementById('math-overlay').classList.add('hidden');
        document.getElementById('tower-select-overlay').classList.add('hidden');
        document.getElementById('tower-upgrade-overlay').classList.add('hidden');
        document.getElementById('start-screen').classList.remove('hidden');
    }
    
    function restartGame() {
        document.getElementById('game-over-screen').classList.add('hidden');
        startGame();
    }

    function togglePause() {
        if(gameState === 'PLAYING') {
            gameState = 'PAUSED';
            document.getElementById('pause-screen').classList.remove('hidden');
        } else if (gameState === 'PAUSED') {
            gameState = 'PLAYING';
            document.getElementById('pause-screen').classList.add('hidden');
            gameLoop();
        }
    }

    function gameLoop() {
        if (gameState !== 'PLAYING') return;
        updateGame();
        drawGame();
        requestAnimationFrame(gameLoop);
    }

    function updateGame() {
        frameCount++;
        document.getElementById('lives-display').innerText = lives;
        document.getElementById('wave-display').innerText = wave;
        document.getElementById('gold-display').innerText = gold;

        let spawnRate = Math.max(30, 100 - (wave * 4));
        if (frameCount % spawnRate === 0) spawnEnemy();
        
        if (frameCount % 1200 === 0) { wave++; playSound('levelup'); }

        towers.forEach(t => t.update());
        
        for (let i = projectiles.length - 1; i >= 0; i--) {
            projectiles[i].update();
            if (!projectiles[i].active) projectiles.splice(i, 1);
        }
        
        for (let i = enemies.length - 1; i >= 0; i--) {
            let e = enemies[i];
            e.update();
            if (e.finished) {
                lives -= e.damage;
                enemies.splice(i, 1);
                playSound('hurt');
                if (lives <= 0) endGame();
            } else if (e.health <= 0) {
                gold += e.reward;
                createParticles(e.x, e.y, e.color);
                enemies.splice(i, 1);
                playSound('explosion');
            }
        }

        for (let i = particles.length - 1; i >= 0; i--) {
            particles[i].update();
            if (particles[i].life <= 0) particles.splice(i, 1);
        }
    }

    function spawnEnemy() {
        let type = 'normal';
        if (wave > 3 && Math.random() < 0.3) type = 'fast';
        if (wave > 5 && Math.random() < 0.2) type = 'tank';
        if (wave % 5 === 0 && Math.random() < 0.05) type = 'boss';
        enemies.push(new Enemy(type));
    }

    function endGame() {
        gameState = 'GAMEOVER';
        document.getElementById('game-over-screen').classList.remove('hidden');
        document.getElementById('final-wave').innerText = wave;
        if(wave > highscore) {
            highscore = wave;
            localStorage.setItem('td_highscore_v4', highscore);
            document.getElementById('highscore-display').innerText = highscore;
        }
    }

    /** --- KLASSER --- **/
    class Enemy {
        constructor(type) {
            this.pathIdx = 0;
            this.x = currentPath[0].x; this.y = currentPath[0].y;
            this.type = type; this.finished = false; this.frozen = 0;
            let hpMult = 1 + (wave * 0.4);
            
            if (type === 'normal') { this.speed=1.5; this.maxHp=20*hpMult; this.emoji='üëæ'; this.reward=5; this.damage=1; this.color='#8e44ad'; }
            if (type === 'fast')   { this.speed=3.0; this.maxHp=12*hpMult; this.emoji='ü¶á'; this.reward=8; this.damage=1; this.color='#e67e22'; }
            if (type === 'tank')   { this.speed=0.8; this.maxHp=60*hpMult; this.emoji='üêó'; this.reward=15; this.damage=2; this.color='#2c3e50'; }
            if (type === 'boss')   { this.speed=0.5; this.maxHp=300*hpMult; this.emoji='üëπ'; this.reward=100; this.damage=10; this.color='#c0392b'; }
            this.health = this.maxHp;
        }
        update() {
            let target = currentPath[this.pathIdx + 1];
            if (!target) { this.finished = true; return; }
            let spd = (this.frozen > 0) ? this.speed * 0.5 : this.speed;
            if(this.frozen > 0) this.frozen--;
            let dx = target.x - this.x; let dy = target.y - this.y;
            let dist = Math.hypot(dx, dy);
            if (dist < spd) { this.x = target.x; this.y = target.y; this.pathIdx++; }
            else { this.x += (dx/dist)*spd; this.y += (dy/dist)*spd; }
        }
        draw() {
            ctx.font = (this.type === 'boss') ? '40px Arial' : '24px Arial';
            ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
            
            // Skygge
            ctx.fillStyle = 'rgba(0,0,0,0.5)';
            ctx.fillText(this.emoji, this.x+2, this.y+2);
            
            ctx.fillStyle = '#fff';
            ctx.fillText(this.emoji, this.x, this.y);

            let hpPct = this.health / this.maxHp;
            ctx.fillStyle = 'red'; ctx.fillRect(this.x - 10, this.y - 20, 20, 4);
            ctx.fillStyle = '#39ff14'; ctx.fillRect(this.x - 10, this.y - 20, 20 * hpPct, 4);
            if(this.frozen > 0) { ctx.fillStyle='rgba(116, 185, 255, 0.5)'; ctx.beginPath(); ctx.arc(this.x,this.y,15,0,Math.PI*2); ctx.fill(); }
        }
    }

    class Tower {
        constructor(x, y, type) {
            this.x = x; this.y = y; this.type = type;
            this.level = 1; this.cooldown = 0;
            if (type === 'normal') { this.range=150; this.dmg=10; this.rate=40; this.emoji='üèπ'; } // Gratis
            if (type === 'sniper') { this.range=300; this.dmg=50; this.rate=100; this.emoji='üî≠'; }
            if (type === 'rapid')  { this.range=120; this.dmg=4; this.rate=10; this.emoji='‚öîÔ∏è'; }
            if (type === 'ice')    { this.range=150; this.dmg=0; this.rate=60; this.emoji='‚ùÑÔ∏è'; }
        }
        update() {
            if (this.cooldown > 0) this.cooldown--;
            if (this.cooldown <= 0) {
                let target = null, minDst = Infinity;
                for (let e of enemies) {
                    let d = Math.hypot(e.x - this.x, e.y - this.y);
                    if (d <= this.range && d < minDst) { minDst = d; target = e; }
                }
                if (target) {
                    projectiles.push(new Projectile(this.x, this.y - 10, target, this.type, this.dmg));
                    this.cooldown = this.rate;
                    playSound('shoot');
                }
            }
        }
        draw() {
            // Tegn t√•rn-struktur (Steinblokk)
            ctx.fillStyle = '#7f8c8d'; // Gr√• stein
            ctx.strokeStyle = '#2c3e50'; // M√∏rk kant
            ctx.lineWidth = 2;
            
            // Base
            ctx.fillRect(this.x - 15, this.y - 10, 30, 20);
            ctx.strokeRect(this.x - 15, this.y - 10, 30, 20);
            
            // Topp kant (battlement)
            ctx.fillRect(this.x - 18, this.y - 15, 36, 8);
            ctx.strokeRect(this.x - 18, this.y - 15, 36, 8);

            // V√•pen Emoji opp√•
            ctx.font = '24px Arial';
            ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
            ctx.fillText(this.emoji, this.x, this.y - 20);
            
            // Level stjerne
            ctx.fillStyle = '#f1c40f';
            ctx.font = '10px Courier New';
            ctx.fillText("‚òÖ" + this.level, this.x + 15, this.y + 15);
        }
    }

    class Projectile {
        constructor(x, y, target, type, dmg) {
            this.x = x; this.y = y; this.target = target; this.type = type; this.dmg = dmg;
            this.speed = (type === 'sniper') ? 15 : 8; this.active = true;
        }
        update() {
            if (!this.target || this.target.health <= 0) { this.active = false; return; }
            let dx = this.target.x - this.x, dy = this.target.y - this.y;
            let dist = Math.hypot(dx, dy);
            if (dist < this.speed) {
                this.active = false;
                if (this.type === 'ice') this.target.frozen = 120;
                else this.target.health -= this.dmg;
            } else { this.x += (dx/dist)*this.speed; this.y += (dy/dist)*this.speed; }
        }
        draw() {
            ctx.fillStyle = (this.type === 'ice') ? '#fff' : '#ffff00';
            ctx.beginPath(); ctx.fillRect(this.x-2, this.y-2, 4, 4); ctx.fill(); // Firkantede prosjektiler (retro)
        }
    }

    class Particle {
        constructor(x, y, color) {
            this.x=x; this.y=y; this.color=color; this.vx=(Math.random()-0.5)*5; this.vy=(Math.random()-0.5)*5; this.life=20;
        }
        update() { this.x+=this.vx; this.y+=this.vy; this.life--; }
    }
    function createParticles(x, y, color) { for(let i=0;i<8;i++) particles.push(new Particle(x,y,color)); }

    /** --- TEGNING --- **/
    function drawGame() {
        if(mapBackgroundImage) {
            ctx.drawImage(mapBackgroundImage, 0, 0);
        } else {
            ctx.clearRect(0,0,canvas.width,canvas.height);
        }

        // Base
        let end = currentPath[currentPath.length-1];
        ctx.font = '40px Arial'; ctx.fillText("üè∞", end.x, end.y - 10);

        // Objekter
        towers.forEach(t => t.draw());
        enemies.forEach(e => e.draw());
        projectiles.forEach(p => p.draw());
        particles.forEach(p => {
            ctx.fillStyle = p.color; 
            ctx.fillRect(p.x, p.y, 4, 4); // Retro firkantede partikler
        });
    }

    /** --- INTERAKSJON --- **/
    canvas.addEventListener('mousedown', function(e) {
        if (gameState !== 'PLAYING') return;
        const rect = canvas.getBoundingClientRect();
        const mx = e.clientX - rect.left, my = e.clientY - rect.top;

        for (let t of towers) {
            if (Math.hypot(t.x - mx, t.y - my) < 30) {
                selectedTower = t;
                openUpgradeMenu();
                return;
            }
        }
        pendingBuildPos = {x: mx, y: my};
        document.getElementById('tower-select-overlay').classList.remove('hidden');
    });

    function selectTowerType(type) {
        let cost = {normal:0, sniper:100, rapid:150, ice:125}[type];
        if (gold < cost) { alert("TRENGER MER GULL!"); return; }
        pendingTowerType = type;
        closeTowerMenu();
        selectedTower = null; 
        openMathModal("BYGG T√ÖRN");
    }

    function openUpgradeMenu() {
        let t = selectedTower;
        let cost = 50 * t.level;
        let val = (t.type=='normal' ? 0 : {sniper:100, rapid:150, ice:125}[t.type]);
        val = Math.floor((val + (50 * (t.level-1))) / 2);
        
        document.getElementById('selected-tower-level').innerText = t.level;
        document.getElementById('upgrade-cost').innerText = cost;
        document.getElementById('sell-value').innerText = val;
        document.getElementById('tower-upgrade-overlay').classList.remove('hidden');
    }

    function initiateUpgrade() {
        if (gold < 50 * selectedTower.level) { alert("TRENGER MER GULL!"); return; }
        closeUpgradeMenu();
        openMathModal("OPPGRADER T√ÖRN");
    }

    function sellTower() {
        let idx = towers.indexOf(selectedTower);
        if(idx > -1) {
            gold += parseInt(document.getElementById('sell-value').innerText);
            towers.splice(idx, 1);
            playSound('success');
            closeUpgradeMenu();
        }
    }

    function buildTowerAction() {
        let t = new Tower(pendingBuildPos.x, pendingBuildPos.y, pendingTowerType);
        towers.push(t);
        gold -= {normal:0, sniper:100, rapid:150, ice:125}[pendingTowerType];
    }
    function upgradeTowerAction(t) {
        gold -= (50 * t.level);
        t.level++;
        t.dmg *= 1.3; t.range *= 1.1;
    }

    /** --- MATTE & LYD --- **/
    function generateQuestion() {
        const r = (max) => Math.floor(Math.random() * max) + 1;
        let q, a;
        if(mathMode==='add_sub'){ let n1=r(20)+wave*2, n2=r(20)+wave*2; if(Math.random()>0.5){q=`${n1} + ${n2}`;a=n1+n2}else{if(n1<n2)[n1,n2]=[n2,n1];q=`${n1} - ${n2}`;a=n1-n2}}
        else if(mathMode==='mult_div'){ let n1=r(9)+1, n2=r(9)+1; if(Math.random()>0.5){q=`${n1} √ó ${n2}`;a=n1*n2}else{let p=n1*n2;q=`${p} : ${n1}`;a=n2}}
        else if(mathMode==='frac_add_sub'){ let d=(r(4)+1)*2,n1=r(d-1),n2=r(d-1); if(Math.random()>0.5){q=`${n1}/${d} + ${n2}/${d}`;a=`${n1+n2}/${d}`}else{if(n1<n2)[n1,n2]=[n2,n1];q=`${n1}/${d} - ${n2}/${d}`;a=`${n1-n2}/${d}`}}
        else if(mathMode==='frac_mult_div'){ let n1=r(3),d1=r(3)+1,n2=r(3),d2=r(3)+1; q=`${n1}/${d1} √ó ${n2}/${d2}`; a=`${n1*n2}/${d1*d2}`; }
        return {question:q, answer:a};
    }

    function checkAnswer() {
        const input = document.getElementById('math-answer');
        const userVal = input.value.trim();
        let isCorrect = false;
        if (String(currentMathAnswer).includes('/')) {
             if (!userVal.includes('/')) { isCorrect = (parseFloat(userVal) == eval(currentMathAnswer)); } 
             else { const [uN, uD] = userVal.split('/').map(Number); const [cN, cD] = currentMathAnswer.split('/').map(Number); if (uD && cD && (uN * cD === cN * uD)) isCorrect = true; }
        } else { if (parseInt(userVal) === parseInt(currentMathAnswer)) isCorrect = true; }

        if (isCorrect) {
            playSound('success');
            if (selectedTower) upgradeTowerAction(selectedTower); else buildTowerAction();
            closeModal();
        } else {
            playSound('error');
            input.style.borderColor = 'red';
            document.getElementById('math-feedback').innerText = "FEIL! PR√òV IGJEN.";
            setTimeout(() => { input.style.borderColor = '#bdc3c7'; }, 500);
        }
    }
    
    function buyHint() {
        if(gold >= 20) {
            gold -= 20; document.getElementById('gold-display').innerText = gold;
            document.getElementById('math-answer').value = currentMathAnswer;
            document.getElementById('math-feedback').innerText = "HINT KJ√òPT!";
        } else document.getElementById('math-feedback').innerText = "TRENGER 20 GULL";
    }

    function closeTowerMenu() { document.getElementById('tower-select-overlay').classList.add('hidden'); }
    function closeUpgradeMenu() { document.getElementById('tower-upgrade-overlay').classList.add('hidden'); }
    function openMathModal(title) {
        gameState = 'MODAL';
        document.getElementById('math-overlay').classList.remove('hidden');
        document.getElementById('math-header').innerText = title;
        document.getElementById('math-feedback').innerText = "";
        let qa = generateQuestion();
        document.getElementById('math-question').innerText = qa.question;
        currentMathAnswer = qa.answer;
        let input = document.getElementById('math-answer');
        input.value = ''; input.focus();
    }
    function closeModal() { document.getElementById('math-overlay').classList.add('hidden'); gameState = 'PLAYING'; gameLoop(); }
    document.getElementById('math-answer').addEventListener("keypress", function(e) { if (e.key === "Enter") checkAnswer(); });

    function initAudio() { if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)(); }
    function playSound(type) {
        if (!audioCtx) return;
        const o = audioCtx.createOscillator(); const g = audioCtx.createGain();
        o.connect(g); g.connect(audioCtx.destination);
        const t = audioCtx.currentTime;
        if (type==='shoot') { o.frequency.setValueAtTime(600, t); o.frequency.exponentialRampToValueAtTime(100, t+0.1); g.gain.setValueAtTime(0.05, t); o.type='square'; o.start(t); o.stop(t+0.1); }
        if (type==='explosion') { o.type='sawtooth'; o.frequency.setValueAtTime(100, t); o.frequency.exponentialRampToValueAtTime(10, t+0.3); g.gain.setValueAtTime(0.1, t); o.start(t); o.stop(t+0.3); }
        if (type==='success') { o.type='triangle'; o.frequency.setValueAtTime(400, t); o.frequency.linearRampToValueAtTime(800, t+0.2); g.gain.setValueAtTime(0.1, t); o.start(t); o.stop(t+0.2); }
        if (type==='error') { o.type='sawtooth'; o.frequency.setValueAtTime(150, t); o.frequency.linearRampToValueAtTime(100, t+0.3); g.gain.setValueAtTime(0.1, t); o.start(t); o.stop(t+0.3); }
    }
</script>
</body>
</html>
