<!DOCTYPE html>
<html lang="no">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Matte-Forsvarerne 9.0</title>
    <style>
        :root {
            --bg-color: #202028;
            --neon-green: #39ff14;
            --neon-pink: #ff00ff;
            --retro-gray: #bdc3c7;
            --ui-bg: #2c3e50;
            --dark-panel: #1a1a1a;
        }

        body {
            font-family: 'Courier New', Courier, monospace;
            margin: 0;
            padding: 0;
            background-color: #111;
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100vh;
            overflow: hidden;
            user-select: none;
        }

        /* --- LAYOUT CONTAINER --- */
        #main-container {
            display: flex;
            gap: 20px;
            margin-top: 20px;
            align-items: flex-start;
        }

        /* --- STATS PANEL (H√òYRE SIDE) --- */
        #stats-panel {
            background: var(--dark-panel);
            border: 4px solid var(--retro-gray);
            width: 250px;
            padding: 15px;
            box-shadow: 0 0 20px #000;
            color: var(--neon-green);
        }

        #stats-panel h3 {
            border-bottom: 2px solid var(--neon-pink);
            padding-bottom: 10px;
            margin-top: 0;
            text-align: center;
            text-shadow: 2px 2px 0 #000;
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 0.9rem;
        }

        .stat-value {
            font-weight: bold;
            color: white;
        }

        /* --- COMBO METER --- */
        #combo-box {
            margin-top: 20px;
            text-align: center;
            padding: 10px;
            border: 2px dashed #555;
            background: #222;
        }
        .combo-active {
            border-color: var(--neon-pink) !important;
            background: #4a004a !important;
            animation: pulse 0.5s infinite;
        }

        /* --- UI BAR --- */
        #ui-bar {
            width: 100%;
            background-color: #000;
            border-bottom: 4px solid var(--retro-gray);
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 1.1rem;
            font-weight: bold;
            z-index: 10;
            box-sizing: border-box;
            color: var(--neon-green);
            text-shadow: 0 0 5px var(--neon-green);
        }

        .control-group button {
            font-family: inherit;
            text-transform: uppercase;
            font-weight: bold;
        }

        /* --- SPILLOMR√ÖDE --- */
        #game-wrapper {
            position: relative;
            box-shadow: 0 0 20px #000;
            border: 4px solid var(--retro-gray);
            background: #000;
        }

        canvas {
            display: block;
            cursor: crosshair;
            image-rendering: pixelated; 
        }

        /* --- MENYER OG MODALER --- */
        .overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.85);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }

        .hidden { display: none !important; }

        h1 { 
            font-size: 2.5rem; 
            margin-bottom: 20px; 
            color: var(--neon-pink); 
            text-shadow: 3px 3px 0px #fff;
            text-transform: uppercase;
            letter-spacing: 3px;
            text-align: center;
        }
        
        h2 { color: #3498db; margin-top: 0; text-transform: uppercase; }
        
        /* RETRO KNAPPER */
        .btn {
            background: #7f8c8d;
            color: white;
            border: 4px outset #ecf0f1;
            padding: 10px 20px;
            font-size: 1rem;
            cursor: pointer;
            margin: 8px;
            font-family: inherit;
            font-weight: bold;
            text-transform: uppercase;
        }
        .btn:active { border-style: inset; transform: translateY(2px); }
        .btn:hover { background: #95a5a6; }
        
        .btn-blue { background: #2980b9; border-color: #3498db; }
        .btn-green { background: #27ae60; border-color: #2ecc71; }
        .btn-red { background: #c0392b; border-color: #e74c3c; }
        .btn-yellow { background: #f39c12; border-color: #f1c40f; color: black; }
        .btn-pulse { animation: pulse 1.5s infinite; }

        /* Aktiv Speed-knapp */
        .btn-speed-active {
            background: var(--neon-pink) !important;
            border-color: #ffccff !important;
            box-shadow: 0 0 15px var(--neon-pink);
            color: white !important;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); box-shadow: 0 0 15px var(--neon-green); }
            100% { transform: scale(1); }
        }

        .selected-btn {
            background: var(--neon-pink) !important;
            border-color: #ffccff !important;
            box-shadow: 0 0 10px var(--neon-pink);
        }

        /* NESTE B√òLGE KNAPP */
        #next-wave-container {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 50;
        }

        /* BOSS ADVARSEL */
        #boss-warning {
            position: absolute;
            top: 40%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 3rem;
            color: red;
            text-shadow: 4px 4px 0 #000;
            font-weight: bold;
            background: rgba(0,0,0,0.8);
            padding: 20px;
            border: 4px solid red;
            display: none;
            z-index: 60;
            animation: blink 0.5s infinite;
        }

        @keyframes blink { 50% { opacity: 0; } }

        /* T√ÖRN MENY */
        #tower-select-menu, #tower-upgrade-menu {
            background: #000080;
            border: 4px double #fff;
            padding: 20px;
            color: white;
            text-align: center;
            box-shadow: 10px 10px 0 #000;
        }
        
        .tower-option {
            display: inline-block;
            margin: 5px;
            cursor: pointer;
            padding: 10px;
            border: 2px dashed #bdc3c7;
            background: #2c3e50;
            width: 100px;
            vertical-align: top;
        }
        .tower-option:hover { background: #34495e; border-color: var(--neon-green); }
        .tower-icon { font-size: 2rem; display: block; margin-bottom: 5px; }
        .price-tag { display: block; font-weight: bold; color: var(--neon-green); margin-top:5px;}
        
        /* MATTE VINDU */
        #math-modal-content {
            background: #ecf0f1;
            border: 4px solid #2c3e50;
            color: black;
            padding: 20px;
            text-align: center;
            width: 380px;
            box-shadow: 15px 15px 0 rgba(0,0,0,0.8);
        }
        #math-header {
            background: #000080;
            color: white;
            margin: -20px -20px 20px -20px;
            padding: 10px;
            font-weight: bold;
        }
        #math-question { font-size: 2.2rem; font-weight: bold; margin: 15px 0; font-family: inherit; }
        
        input[type="text"] {
            padding: 10px;
            font-size: 1.5rem;
            width: 70%;
            margin-bottom: 15px;
            border: 3px inset #bdc3c7;
            background: #fff;
            text-align: center;
            font-family: inherit;
            color: black;
        }
    </style>
</head>
<body>

    <div id="ui-bar">
        <div class="stats-group">
            <span>‚ù§Ô∏è <span id="lives-display">20</span></span>
            <span>üåä <span id="wave-display">1</span></span>
            <span>üí∞ <span id="gold-display">150</span></span>
            <span>üèÜ <span id="highscore-display">0</span></span>
        </div>
        <div class="control-group">
            <button class="btn btn-blue" onclick="toggleSpeed()" id="speed-btn" style="padding: 5px 10px; font-size: 0.8rem;">‚è©</button>
            <button class="btn btn-yellow" onclick="togglePause()" id="pause-btn" style="padding: 5px 10px; font-size: 0.8rem;">||</button>
            <button class="btn btn-red" onclick="backToMenu()" style="padding: 5px 10px; font-size: 0.8rem;">X</button>
        </div>
    </div>

    <div id="main-container">
        
        <div id="game-wrapper">
            <canvas id="gameCanvas" width="800" height="600"></canvas>

            <div id="next-wave-container" class="hidden">
                <button class="btn btn-green btn-pulse" onclick="startNextWave()">START B√òLGE <span id="next-wave-num">1</span> ‚ñ∂</button>
            </div>

            <div id="boss-warning">‚ö†Ô∏è ADVARSEL: BOSS! ‚ö†Ô∏è</div>

            <div id="start-screen" class="overlay">
                <h1>Matte-Forsvarerne<br><span style="font-size:1.5rem; color:#fff;">Speed Edition</span></h1>
                
                <div style="display:flex; gap: 20px; margin-bottom: 20px;">
                    <div style="text-align:center;">
                        <h3 style="color:#bdc3c7">VELG BRETT</h3>
                        <button class="btn" onclick="selectMap(this, 'forest')">üå≤ SKOG (Lett)</button><br>
                        <button class="btn" onclick="selectMap(this, 'desert')">üåµ √òRKEN (Middels)</button><br>
                        <button class="btn" onclick="selectMap(this, 'volcano')">üåã VULKAN (Vanskelig)</button>
                    </div>
                    <div style="text-align:center;">
                        <h3 style="color:#bdc3c7">VELG REGNEART</h3>
                        <button class="btn" onclick="setMathMode(this, 'add_sub')">PLUSS / MINUS</button><br>
                        <button class="btn" onclick="setMathMode(this, 'mult_div')">GANGE / DELE</button><br>
                        <button class="btn" onclick="setMathMode(this, 'frac_add_sub')">BR√òK (+/-)</button><br>
                        <button class="btn" onclick="setMathMode(this, 'frac_mult_div')">BR√òK (* / :)</button>
                    </div>
                </div>
                
                <button id="start-btn" class="btn btn-green" style="font-size: 1.5rem; padding: 15px 50px;" disabled onclick="initGame()">START SPILLET</button>
            </div>

            <div id="tower-select-overlay" class="overlay hidden" style="background: rgba(0,0,0,0.6);">
                <div id="tower-select-menu">
                    <h3 style="margin-top:0; border-bottom: 2px solid white; padding-bottom:10px;">VELG FORSVAR</h3>
                    <div class="tower-option" onclick="selectTowerType('normal')">
                        <span class="tower-icon">üèπ</span>
                        <b>BUE</b><br><span class="price-tag">25 G</span>
                    </div>
                    <div class="tower-option" onclick="selectTowerType('sniper')">
                        <span class="tower-icon">üî≠</span>
                        <b>SNIPER</b><br><span class="price-tag">100 G</span>
                    </div>
                    <div class="tower-option" onclick="selectTowerType('rapid')">
                        <span class="tower-icon">‚öîÔ∏è</span>
                        <b>RASK</b><br><span class="price-tag">150 G</span>
                    </div>
                    <div class="tower-option" onclick="selectTowerType('ice')">
                        <span class="tower-icon">‚ùÑÔ∏è</span>
                        <b>FROST</b><br><span class="price-tag">125 G</span>
                    </div>
                    <br>
                    <button class="btn btn-red" onclick="closeTowerMenu()">AVBRYT</button>
                </div>
            </div>

            <div id="tower-upgrade-overlay" class="overlay hidden" style="background: rgba(0,0,0,0.6);">
                <div id="tower-upgrade-menu">
                    <h3>T√ÖRN MENY</h3>
                    <p>NIV√Ö: <span id="selected-tower-level" style="color:var(--neon-green)">1</span></p>
                    <button class="btn btn-blue" onclick="initiateUpgrade()">
                        OPPGRADER ‚¨ÜÔ∏è<br><small>PRIS: <span id="upgrade-cost">0</span> G</small>
                    </button>
                    <button class="btn btn-red" onclick="sellTower()">
                        SELG üí∏<br><small>VERDI: <span id="sell-value">0</span> G</small>
                    </button>
                    <br>
                    <button class="btn" onclick="closeUpgradeMenu()">LUKK</button>
                </div>
            </div>

            <div id="math-overlay" class="overlay hidden">
                <div id="math-modal-content">
                    <div id="math-header">MATTE-OPPGAVE</div>
                    <div id="math-question">...</div>
                    <input type="text" id="math-answer" placeholder="?" autocomplete="off">
                    <div class="hint-text" id="math-feedback" style="color: red; min-height: 20px;"></div>
                    <div>
                        <button class="btn btn-green" onclick="checkAnswer()">SVAR ‚Üµ</button>
                        <button class="btn btn-yellow" onclick="buyHint()">HINT (20G)</button>
                    </div>
                    <button class="btn btn-red" style="margin-top:10px; font-size: 0.8rem;" onclick="closeModal()">AVBRYT</button>
                </div>
            </div>

            <div id="game-over-screen" class="overlay hidden">
                <h1 style="color: red;">GAME OVER</h1>
                <p>B√òLGE N√ÖDD: <span id="final-wave" style="color: white; font-size: 2rem;">0</span></p>
                <div>
                    <button class="btn btn-green" onclick="restartGame()">PR√òV IGJEN</button>
                    <button class="btn btn-red" onclick="backToMenu()">MENY</button>
                </div>
            </div>
            
            <div id="pause-screen" class="overlay hidden">
                <h1 style="color: yellow; text-shadow: 4px 4px 0 #000;">PAUSE</h1>
                <button class="btn btn-green" onclick="togglePause()">FORTSETT</button>
            </div>
        </div>

        <div id="stats-panel">
            <h3>L√ÜRERENS LOGG</h3>
            <div class="stat-row">
                <span>Skudd i runde:</span>
                <span id="stat-shots" class="stat-value">0</span>
            </div>
            <div class="stat-row">
                <span>Monstre knertet:</span>
                <span id="stat-kills" class="stat-value">0</span>
            </div>
            <div class="stat-row">
                <span>Treffsikkerhet:</span>
                <span id="stat-accuracy" class="stat-value">100%</span>
            </div>
            <hr style="border-color:#555;">
            
            <div id="combo-box">
                <div style="font-size:0.8rem; color:#aaa;">Riktig p√• rad</div>
                <div id="combo-count" style="font-size:3rem; font-weight:bold; color:white;">0</div>
                <div id="combo-msg" style="font-size:0.8rem; color:var(--neon-pink); min-height:1.2em;"></div>
            </div>
            
            <div style="margin-top:20px; font-size:0.8rem; color:#777;">
                Tips: F√• 3 riktige p√• rad for 50 gull bonus!
            </div>
        </div>

    </div>

<script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    
    // Global tilstand
    let gameState = 'MENU';
    let mathMode = null;
    let selectedMap = null;
    let lives = 20;
    let wave = 1;
    let gold = 150;
    let frameCount = 0;
    let highscore = localStorage.getItem('td_highscore_v9') || 0;
    document.getElementById('highscore-display').innerText = highscore;
    let waveActive = false;
    let speedMultiplier = 1;

    // Statistikk
    let statsShots = 0;
    let statsKills = 0;
    let comboStreak = 0;

    // Boss logikk
    let waveEnemiesSpawned = 0;
    let waveTotalEnemies = 0;
    let bossSpawnedInWave = false;
    let waitingForBoss = false;

    let mapBackgroundImage = null;
    let towers = [];
    let enemies = [];
    let projectiles = [];
    let particles = [];
    let floatingTexts = [];

    // Mouse tracking for hover effects
    let mouseX = 0;
    let mouseY = 0;

    const maps = {
        forest: {
            baseColor: '#27ae60', noiseColor: '#1e8449', pathColor: '#7f8c8d', difficultyMult: 1.0, startGold: 150,
            path: [ {x:0, y:100}, {x:700, y:100}, {x:700, y:250}, {x:100, y:250}, {x:100, y:400}, {x:700, y:400}, {x:700, y:550}, {x:800, y:550} ]
        },
        desert: {
            baseColor: '#f1c40f', noiseColor: '#d35400', pathColor: '#e67e22', difficultyMult: 1.5, startGold: 150,
            path: [ {x:0, y:50}, {x:100, y:50}, {x:100, y:500}, {x:250, y:500}, {x:250, y:100}, {x:400, y:100}, {x:400, y:500}, {x:550, y:500}, {x:550, y:100}, {x:700, y:100}, {x:700, y:400}, {x:800, y:400} ]
        },
        volcano: {
            baseColor: '#2c3e50', noiseColor: '#c0392b', pathColor: '#111', difficultyMult: 2.0, startGold: 175,
            path: [ {x:0, y:550}, {x:100, y:550}, {x:100, y:100}, {x:300, y:100}, {x:300, y:450}, {x:500, y:450}, {x:500, y:100}, {x:700, y:100}, {x:700, y:500}, {x:800, y:500} ]
        }
    };
    let currentPath = [];
    let pendingBuildPos = null;
    let pendingTowerType = null;
    let selectedTower = null;
    let currentMathAnswer = null;
    let audioCtx = null;

    // --- BAKGRUNN ---
    function generateMapTexture(mapData) {
        const offCanvas = document.createElement('canvas');
        offCanvas.width = 800; offCanvas.height = 600;
        const oCtx = offCanvas.getContext('2d');
        oCtx.fillStyle = mapData.baseColor; oCtx.fillRect(0, 0, 800, 600);
        oCtx.fillStyle = mapData.noiseColor;
        for (let i = 0; i < 20000; i++) {
            let x = Math.random() * 800, y = Math.random() * 600, s = Math.random() * 2 + 1;
            oCtx.fillRect(x, y, s, s);
        }
        oCtx.strokeStyle = 'rgba(0,0,0,0.1)'; oCtx.lineWidth = 1;
        oCtx.beginPath();
        for(let i=0; i<800; i+=50) { oCtx.moveTo(i,0); oCtx.lineTo(i,600); }
        for(let i=0; i<600; i+=50) { oCtx.moveTo(0,i); oCtx.lineTo(800,i); }
        oCtx.stroke();
        oCtx.lineCap = 'round'; oCtx.lineJoin = 'round';
        oCtx.strokeStyle = 'rgba(0,0,0,0.3)'; oCtx.lineWidth = 55;
        oCtx.beginPath(); oCtx.moveTo(mapData.path[0].x, mapData.path[0].y + 5);
        mapData.path.forEach(p => oCtx.lineTo(p.x, p.y + 5)); oCtx.stroke();
        oCtx.strokeStyle = mapData.pathColor; oCtx.lineWidth = 45;
        oCtx.beginPath(); oCtx.moveTo(mapData.path[0].x, mapData.path[0].y);
        mapData.path.forEach(p => oCtx.lineTo(p.x, p.y)); oCtx.stroke();
        return offCanvas;
    }

    // --- LOGIKK ---
    function selectMap(btn, mapName) {
        selectedMap = mapName;
        [...btn.parentElement.children].forEach(c => {if(c.tagName==='BUTTON') c.classList.remove('selected-btn')});
        btn.classList.add('selected-btn');
        checkStartReady();
    }
    function setMathMode(btn, mode) {
        mathMode = mode;
        [...btn.parentElement.children].forEach(c => {if(c.tagName==='BUTTON') c.classList.remove('selected-btn')});
        btn.classList.add('selected-btn');
        checkStartReady();
    }
    function checkStartReady() { document.getElementById('start-btn').disabled = !(selectedMap && mathMode); }

    function initGame() {
        lives = (selectedMap === 'volcano') ? 15 : 20;
        gold = maps[selectedMap].startGold;
        wave = 1;
        frameCount = 0;
        towers = []; enemies = []; projectiles = []; particles = []; floatingTexts = [];
        currentPath = maps[selectedMap].path;
        mapBackgroundImage = generateMapTexture(maps[selectedMap]);
        resetStats();
        
        gameState = 'PLAYING';
        waveActive = false;
        speedMultiplier = 1;
        updateSpeedBtn();
        
        document.getElementById('start-screen').classList.add('hidden');
        document.getElementById('next-wave-container').classList.remove('hidden');
        document.getElementById('next-wave-num').innerText = wave;
        
        initAudio();
        gameLoop();
    }

    function resetStats() {
        statsShots = 0;
        statsKills = 0;
        comboStreak = 0;
        updateStatsUI();
    }

    function updateStatsUI() {
        document.getElementById('stat-shots').innerText = statsShots;
        document.getElementById('stat-kills').innerText = statsKills;
        let acc = statsShots > 0 ? Math.round((statsKills / statsShots) * 100) : 100;
        if(acc > 100) acc = 100; 
        document.getElementById('stat-accuracy').innerText = acc + "%";
        document.getElementById('combo-count').innerText = comboStreak;
        
        const comboBox = document.getElementById('combo-box');
        if(comboStreak >= 3) {
            comboBox.classList.add('combo-active');
            document.getElementById('combo-msg').innerText = "üî• COMBO BONUS! üî•";
        } else {
            comboBox.classList.remove('combo-active');
            document.getElementById('combo-msg').innerText = "";
        }
    }

    function toggleSpeed() {
        if(gameState !== 'PLAYING') return;
        speedMultiplier = (speedMultiplier === 1) ? 3 : 1;
        updateSpeedBtn();
    }
    
    function updateSpeedBtn() {
        const btn = document.getElementById('speed-btn');
        if(speedMultiplier > 1) {
            btn.classList.add('btn-speed-active');
        } else {
            btn.classList.remove('btn-speed-active');
        }
    }

    function startNextWave() {
        waveActive = true;
        speedMultiplier = 1; // Reset speed on new wave
        updateSpeedBtn();
        document.getElementById('next-wave-container').classList.add('hidden');
        frameCount = 0;
        waveEnemiesSpawned = 0;
        bossSpawnedInWave = false;
        waitingForBoss = false;
        
        waveTotalEnemies = 5 + (wave * 2); 
        
        statsShots = 0;
        statsKills = 0;
        updateStatsUI();
        
        playSound('levelup');
    }

    function backToMenu() {
        if(!confirm("Avslutte til meny?")) return;
        gameState = 'MENU';
        document.getElementById('game-over-screen').classList.add('hidden');
        document.getElementById('pause-screen').classList.add('hidden');
        document.getElementById('math-overlay').classList.add('hidden');
        document.getElementById('tower-select-overlay').classList.add('hidden');
        document.getElementById('tower-upgrade-overlay').classList.add('hidden');
        document.getElementById('start-screen').classList.remove('hidden');
        document.getElementById('next-wave-container').classList.add('hidden');
        document.getElementById('boss-warning').style.display = 'none';
    }
    
    function restartGame() {
        document.getElementById('game-over-screen').classList.add('hidden');
        initGame();
    }

    function togglePause() {
        if(gameState === 'PLAYING') {
            gameState = 'PAUSED';
            document.getElementById('pause-screen').classList.remove('hidden');
        } else if (gameState === 'PAUSED') {
            gameState = 'PLAYING';
            document.getElementById('pause-screen').classList.add('hidden');
            gameLoop();
        }
    }

    function gameLoop() {
        if (gameState !== 'PLAYING') return;
        
        // Loop logic multiple times for speed
        for(let i=0; i<speedMultiplier; i++) {
            updateGame();
        }
        
        drawGame();
        requestAnimationFrame(gameLoop);
    }

    function updateGame() {
        if(waveActive) frameCount++;
        
        document.getElementById('lives-display').innerText = lives;
        document.getElementById('wave-display').innerText = wave;
        document.getElementById('gold-display').innerText = gold;

        // --- B√òLGE & BOSS LOGIKK ---
        if(waveActive) {
            let isBossLevel = (wave % 5 === 0);
            let spawnRate = Math.max(20, 80 - (wave * 2)); 
            
            if (waveEnemiesSpawned < waveTotalEnemies) {
                if (frameCount % spawnRate === 0) {
                    spawnEnemy('normal_pool');
                    waveEnemiesSpawned++;
                }
            }
            else if (isBossLevel && !bossSpawnedInWave) {
                if (enemies.length === 0) {
                    if (!waitingForBoss) {
                        waitingForBoss = true;
                        document.getElementById('boss-warning').style.display = 'block';
                        setTimeout(() => {
                            spawnEnemy('boss');
                            bossSpawnedInWave = true;
                            document.getElementById('boss-warning').style.display = 'none';
                            waitingForBoss = false;
                        }, 3000); 
                    }
                }
            }

            if (waveEnemiesSpawned >= waveTotalEnemies && enemies.length === 0 && !waitingForBoss) {
                if (!isBossLevel || (isBossLevel && bossSpawnedInWave)) {
                    waveActive = false;
                    wave++;
                    document.getElementById('next-wave-container').classList.remove('hidden');
                    document.getElementById('next-wave-num').innerText = wave;
                    // Auto-reset speed
                    speedMultiplier = 1;
                    updateSpeedBtn();
                }
            }
        }

        towers.forEach(t => t.update());
        
        for (let i = projectiles.length - 1; i >= 0; i--) {
            projectiles[i].update();
            if (!projectiles[i].active) projectiles.splice(i, 1);
        }
        
        for (let i = enemies.length - 1; i >= 0; i--) {
            let e = enemies[i];
            e.update();
            if (e.finished) {
                lives -= e.damage;
                enemies.splice(i, 1);
                playSound('hurt');
                if (lives <= 0) endGame();
            } else if (e.health <= 0) {
                gold += e.reward;
                statsKills++;
                updateStatsUI();
                createParticles(e.x, e.y, e.color);
                enemies.splice(i, 1);
                playSound('explosion');
            }
        }

        for (let i = particles.length - 1; i >= 0; i--) {
            particles[i].update();
            if (particles[i].life <= 0) particles.splice(i, 1);
        }
        
        for (let i = floatingTexts.length - 1; i >= 0; i--) {
            floatingTexts[i].update();
            if (floatingTexts[i].life <= 0) floatingTexts.splice(i, 1);
        }
    }

    function spawnEnemy(forceType) {
        let type = 'normal';
        
        if (forceType === 'boss') {
            type = 'boss';
        } else {
            let r = Math.random();
            if (wave > 2 && r < 0.3) type = 'fast';
            if (wave > 4 && r < 0.2) type = 'tank';
        }
        enemies.push(new Enemy(type));
    }

    function endGame() {
        gameState = 'GAMEOVER';
        document.getElementById('game-over-screen').classList.remove('hidden');
        document.getElementById('final-wave').innerText = wave;
        if(wave > highscore) {
            highscore = wave;
            localStorage.setItem('td_highscore_v9', highscore);
            document.getElementById('highscore-display').innerText = highscore;
        }
    }

    // --- ENTITETER ---
    class Enemy {
        constructor(type) {
            this.pathIdx = 0;
            this.x = currentPath[0].x; this.y = currentPath[0].y;
            this.type = type; this.finished = false; this.frozen = 0;
            let hpMult = 1 + (wave * 0.8); 
            
            if (type === 'normal') { this.speed=1.5; this.maxHp=30*hpMult; this.emoji='üëæ'; this.reward=5; this.damage=1; this.color='#8e44ad'; }
            if (type === 'fast')   { this.speed=3.0; this.maxHp=15*hpMult; this.emoji='ü¶á'; this.reward=8; this.damage=1; this.color='#e67e22'; }
            if (type === 'tank')   { this.speed=0.8; this.maxHp=80*hpMult; this.emoji='üêó'; this.reward=15; this.damage=2; this.color='#2c3e50'; }
            if (type === 'boss')   { this.speed=0.5; this.maxHp=500*hpMult; this.emoji='üëπ'; this.reward=250; this.damage=10; this.color='#c0392b'; }
            this.health = this.maxHp;
        }
        update() {
            let target = currentPath[this.pathIdx + 1];
            if (!target) { this.finished = true; return; }
            let spd = (this.frozen > 0) ? this.speed * 0.5 : this.speed;
            if(this.frozen > 0) this.frozen--;
            let dx = target.x - this.x; let dy = target.y - this.y;
            let dist = Math.hypot(dx, dy);
            if (dist < spd) { this.x = target.x; this.y = target.y; this.pathIdx++; }
            else { this.x += (dx/dist)*spd; this.y += (dy/dist)*spd; }
        }
        draw() {
            let size = (this.type === 'boss') ? '60px' : '24px';
            ctx.font = size + ' Arial';
            ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
            ctx.fillStyle = 'rgba(0,0,0,0.5)'; ctx.fillText(this.emoji, this.x+2, this.y+2);
            ctx.fillStyle = '#fff'; ctx.fillText(this.emoji, this.x, this.y);
            let hpPct = this.health / this.maxHp;
            ctx.fillStyle = 'red'; ctx.fillRect(this.x - 10, this.y - 20, 20, 4);
            ctx.fillStyle = '#39ff14'; ctx.fillRect(this.x - 10, this.y - 20, 20 * hpPct, 4);
            
            if (this.type === 'boss') {
                 ctx.fillStyle = 'white'; ctx.font = '12px Courier';
                 ctx.fillText("BOSS", this.x, this.y - 35);
            }
        }
    }

    class Tower {
        constructor(x, y, type) {
            this.x = x; this.y = y; this.type = type;
            this.level = 1; this.cooldown = 0;
            if (type === 'normal') { this.range=150; this.dmg=15; this.rate=40; this.emoji='üèπ'; } 
            if (type === 'sniper') { this.range=350; this.dmg=80; this.rate=90; this.emoji='üî≠'; }
            if (type === 'rapid')  { this.range=120; this.dmg=6; this.rate=8; this.emoji='‚öîÔ∏è'; }
            if (type === 'ice')    { this.range=150; this.dmg=0; this.rate=50; this.emoji='‚ùÑÔ∏è'; }
        }
        update() {
            if (this.cooldown > 0) this.cooldown--;
            if (this.cooldown <= 0) {
                let target = null, minDst = Infinity;
                for (let e of enemies) {
                    let d = Math.hypot(e.x - this.x, e.y - this.y);
                    if (d <= this.range && d < minDst) { minDst = d; target = e; }
                }
                if (target) {
                    projectiles.push(new Projectile(this.x, this.y - 10, target, this.type, this.dmg));
                    this.cooldown = this.rate;
                    playSound('shoot');
                    statsShots++;
                    updateStatsUI();
                }
            }
        }
        draw() {
            if(Math.hypot(this.x - mouseX, this.y - mouseY) < 30) {
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.range, 0, Math.PI*2);
                ctx.fillStyle = 'rgba(255, 255, 255, 0.2)'; ctx.fill();
                ctx.strokeStyle = 'white'; ctx.lineWidth = 1; ctx.stroke();
            }
            ctx.fillStyle = '#7f8c8d'; ctx.strokeStyle = '#2c3e50'; ctx.lineWidth = 2;
            ctx.fillRect(this.x - 15, this.y - 10, 30, 20); ctx.strokeRect(this.x - 15, this.y - 10, 30, 20);
            ctx.fillRect(this.x - 18, this.y - 15, 36, 8); ctx.strokeRect(this.x - 18, this.y - 15, 36, 8);
            ctx.font = '24px Arial'; ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
            ctx.fillText(this.emoji, this.x, this.y - 20);
            ctx.fillStyle = '#f1c40f'; ctx.font = '10px Courier New';
            ctx.fillText("‚òÖ" + this.level, this.x + 15, this.y + 15);
        }
    }

    class Projectile {
        constructor(x, y, target, type, dmg) {
            this.x = x; this.y = y; this.target = target; this.type = type; this.dmg = dmg;
            this.speed = (type === 'sniper') ? 20 : 10; this.active = true;
        }
        update() {
            if (!this.target || this.target.health <= 0) { this.active = false; return; }
            let dx = this.target.x - this.x, dy = this.target.y - this.y;
            let dist = Math.hypot(dx, dy);
            if (dist < this.speed) {
                this.active = false;
                if (this.type === 'ice') this.target.frozen = 120;
                else {
                    this.target.health -= this.dmg;
                    floatingTexts.push(new FloatingText(this.target.x, this.target.y, "-" + Math.floor(this.dmg), '#fff'));
                }
            } else { this.x += (dx/dist)*this.speed; this.y += (dy/dist)*this.speed; }
        }
        draw() {
            ctx.fillStyle = (this.type === 'ice') ? '#fff' : '#ffff00';
            ctx.fillRect(this.x-2, this.y-2, 4, 4);
        }
    }

    class Particle {
        constructor(x, y, color) {
            this.x=x; this.y=y; this.color=color; this.vx=(Math.random()-0.5)*5; this.vy=(Math.random()-0.5)*5; this.life=20;
        }
        update() { this.x+=this.vx; this.y+=this.vy; this.life--; }
    }
    
    class FloatingText {
        constructor(x, y, text, color) {
            this.x = x; this.y = y; this.text = text; this.life = 40; this.vy = -1; this.color = color;
        }
        update() { this.y += this.vy; this.life--; }
    }

    function createParticles(x, y, color) { for(let i=0;i<8;i++) particles.push(new Particle(x,y,color)); }

    // --- TEGNING ---
    function drawGame() {
        if(mapBackgroundImage) ctx.drawImage(mapBackgroundImage, 0, 0);
        else ctx.clearRect(0,0,canvas.width,canvas.height);

        let end = currentPath[currentPath.length-1];
        ctx.font = '40px Arial'; ctx.fillText("üè∞", end.x, end.y - 10);

        towers.forEach(t => t.draw());
        enemies.forEach(e => e.draw());
        projectiles.forEach(p => p.draw());
        particles.forEach(p => { ctx.fillStyle = p.color; ctx.fillRect(p.x, p.y, 4, 4); });
        
        ctx.font = 'bold 16px Courier New';
        floatingTexts.forEach(t => {
            ctx.fillStyle = t.color;
            ctx.globalAlpha = t.life/40;
            ctx.fillText(t.text, t.x, t.y);
            ctx.globalAlpha = 1.0;
        });
    }

    // --- INTERAKSJON ---
    canvas.addEventListener('mousemove', function(e) {
        const rect = canvas.getBoundingClientRect();
        mouseX = e.clientX - rect.left;
        mouseY = e.clientY - rect.top;
    });

    canvas.addEventListener('mousedown', function(e) {
        if (gameState !== 'PLAYING') return;
        const rect = canvas.getBoundingClientRect();
        const mx = e.clientX - rect.left, my = e.clientY - rect.top;

        for (let t of towers) {
            if (Math.hypot(t.x - mx, t.y - my) < 30) {
                selectedTower = t;
                openUpgradeMenu();
                return;
            }
        }
        
        if(!waveActive) {
            floatingTexts.push(new FloatingText(mx, my, "START B√òLGEN F√òRST!", '#e74c3c'));
            playSound('error');
            return;
        }

        pendingBuildPos = {x: mx, y: my};
        document.getElementById('tower-select-overlay').classList.remove('hidden');
    });

    function selectTowerType(type) {
        let cost = {normal:25, sniper:100, rapid:150, ice:125}[type];
        if (gold < cost) { alert("TRENGER MER GULL!"); return; }
        pendingTowerType = type;
        closeTowerMenu();
        selectedTower = null; 
        openMathModal("BYGG T√ÖRN");
    }

    function openUpgradeMenu() {
        let t = selectedTower;
        let cost = 50 * t.level;
        let val = (t.type=='normal' ? 25 : {sniper:100, rapid:150, ice:125}[t.type]);
        val = Math.floor((val + (50 * (t.level-1))) / 2);
        document.getElementById('selected-tower-level').innerText = t.level;
        document.getElementById('upgrade-cost').innerText = cost;
        document.getElementById('sell-value').innerText = val;
        document.getElementById('tower-upgrade-overlay').classList.remove('hidden');
    }

    function initiateUpgrade() {
        if (gold < 50 * selectedTower.level) { alert("TRENGER MER GULL!"); return; }
        closeUpgradeMenu();
        openMathModal("OPPGRADER T√ÖRN");
    }

    function sellTower() {
        let idx = towers.indexOf(selectedTower);
        if(idx > -1) {
            gold += parseInt(document.getElementById('sell-value').innerText);
            towers.splice(idx, 1);
            playSound('success');
            closeUpgradeMenu();
        }
    }

    function buildTowerAction() {
        let t = new Tower(pendingBuildPos.x, pendingBuildPos.y, pendingTowerType);
        towers.push(t);
        gold -= {normal:25, sniper:100, rapid:150, ice:125}[pendingTowerType];
    }
    function upgradeTowerAction(t) {
        gold -= (50 * t.level);
        t.level++;
        t.dmg *= 1.3; t.range *= 1.1;
    }

    // --- MATTE ---
    function generateQuestion() {
        const r = (max) => Math.floor(Math.random() * max) + 1;
        let mapDiff = maps[selectedMap].difficultyMult;
        let diffFactor = Math.ceil(wave * mapDiff); 
        
        let q, a;
        if(mathMode==='add_sub'){ 
            let range = 20 + (diffFactor * 5); 
            let n1=r(range), n2=r(range); 
            if(Math.random()>0.5){q=`${n1} + ${n2}`;a=n1+n2}
            else{if(n1<n2)[n1,n2]=[n2,n1];q=`${n1} - ${n2}`;a=n1-n2}
        }
        else if(mathMode==='mult_div'){ 
            let range = Math.min(12, 5 + Math.ceil(diffFactor/2)); 
            let n1=r(range)+1, n2=r(range)+1; 
            if(Math.random()>0.5){q=`${n1} √ó ${n2}`;a=n1*n2}
            else{let p=n1*n2;q=`${p} : ${n1}`;a=n2}
        }
        else if(mathMode==='frac_add_sub'){ 
            let d=(r(4)+1)*2, n1=r(d-1), n2=r(d-1); 
            if(Math.random()>0.5){q=`${n1}/${d} + ${n2}/${d}`;a=`${n1+n2}/${d}`}
            else{if(n1<n2)[n1,n2]=[n2,n1];q=`${n1}/${d} - ${n2}/${d}`;a=`${n1-n2}/${d}`}
        }
        else if(mathMode==='frac_mult_div'){ 
            let range = 3 + Math.floor(diffFactor/3);
            let n1=r(range),d1=r(range)+1,n2=r(range),d2=r(range)+1; 
            q=`${n1}/${d1} √ó ${n2}/${d2}`; a=`${n1*n2}/${d1*d2}`; 
        }
        return {question:q, answer:a};
    }

    function checkAnswer() {
        const input = document.getElementById('math-answer');
        const userVal = input.value.trim();
        let isCorrect = false;
        if (String(currentMathAnswer).includes('/')) {
             if (!userVal.includes('/')) { isCorrect = (parseFloat(userVal) == eval(currentMathAnswer)); } 
             else { const [uN, uD] = userVal.split('/').map(Number); const [cN, cD] = currentMathAnswer.split('/').map(Number); if (uD && cD && (uN * cD === cN * uD)) isCorrect = true; }
        } else { if (parseInt(userVal) === parseInt(currentMathAnswer)) isCorrect = true; }

        if (isCorrect) {
            playSound('success');
            
            // Combo logikk
            comboStreak++;
            if(comboStreak === 3) {
                gold += 50;
                floatingTexts.push(new FloatingText(400, 300, "COMBO! +50 GULL", '#ff00ff'));
                playSound('levelup');
            }
            updateStatsUI();

            if (selectedTower) upgradeTowerAction(selectedTower); else buildTowerAction();
            closeModal();
        } else {
            playSound('error');
            
            // Nullstill combo
            comboStreak = 0;
            updateStatsUI();
            
            input.style.borderColor = 'red';
            document.getElementById('math-feedback').innerText = "FEIL! PR√òV IGJEN.";
            setTimeout(() => { input.style.borderColor = '#bdc3c7'; }, 500);
        }
    }
    
    function buyHint() {
        if(gold >= 20) {
            gold -= 20; document.getElementById('gold-display').innerText = gold;
            document.getElementById('math-answer').value = currentMathAnswer;
            document.getElementById('math-feedback').innerText = "HINT KJ√òPT!";
        } else document.getElementById('math-feedback').innerText = "TRENGER 20 GULL";
    }

    function closeTowerMenu() { document.getElementById('tower-select-overlay').classList.add('hidden'); }
    function closeUpgradeMenu() { document.getElementById('tower-upgrade-overlay').classList.add('hidden'); }
    function openMathModal(title) {
        gameState = 'MODAL';
        document.getElementById('math-overlay').classList.remove('hidden');
        document.getElementById('math-header').innerText = title;
        document.getElementById('math-feedback').innerText = "";
        let qa = generateQuestion();
        document.getElementById('math-question').innerText = qa.question;
        currentMathAnswer = qa.answer;
        let input = document.getElementById('math-answer');
        input.value = ''; input.focus();
    }
    function closeModal() { document.getElementById('math-overlay').classList.add('hidden'); gameState = 'PLAYING'; gameLoop(); }
    document.getElementById('math-answer').addEventListener("keypress", function(e) { if (e.key === "Enter") checkAnswer(); });

    function initAudio() { if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)(); }
    function playSound(type) {
        if (!audioCtx) return;
        const o = audioCtx.createOscillator(); const g = audioCtx.createGain();
        o.connect(g); g.connect(audioCtx.destination);
        const t = audioCtx.currentTime;
        if (type==='shoot') { o.frequency.setValueAtTime(600, t); o.frequency.exponentialRampToValueAtTime(100, t+0.1); g.gain.setValueAtTime(0.05, t); o.type='square'; o.start(t); o.stop(t+0.1); }
        if (type==='explosion') { o.type='sawtooth'; o.frequency.setValueAtTime(100, t); o.frequency.exponentialRampToValueAtTime(10, t+0.3); g.gain.setValueAtTime(0.1, t); o.start(t); o.stop(t+0.3); }
        if (type==='success') { o.type='triangle'; o.frequency.setValueAtTime(400, t); o.frequency.linearRampToValueAtTime(800, t+0.2); g.gain.setValueAtTime(0.1, t); o.start(t); o.stop(t+0.2); }
        if (type==='error') { o.type='sawtooth'; o.frequency.setValueAtTime(150, t); o.frequency.linearRampToValueAtTime(100, t+0.3); g.gain.setValueAtTime(0.1, t); o.start(t); o.stop(t+0.3); }
        if (type==='levelup') { o.type='sine'; o.frequency.setValueAtTime(300, t); o.frequency.linearRampToValueAtTime(600, t+0.2); o.frequency.linearRampToValueAtTime(900, t+0.4); g.gain.setValueAtTime(0.1, t); o.start(t); o.stop(t+0.6); }
        if (type==='hurt') { o.type='sawtooth'; o.frequency.setValueAtTime(100, t); o.frequency.linearRampToValueAtTime(50, t+0.2); g.gain.setValueAtTime(0.2, t); o.start(t); o.stop(t+0.2); }
    }
</script>
</body>
</html>
