<!DOCTYPE html>
<html lang="no">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Matte-Forsvarerne</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #2c3e50;
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100vh;
            overflow: hidden;
        }

        #ui-bar {
            width: 100%;
            background-color: #34495e;
            padding: 10px 0;
            display: flex;
            justify-content: space-around;
            font-size: 1.2rem;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }

        #game-container {
            position: relative;
            margin-top: 20px;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }

        canvas {
            background-color: #27ae60; /* Grasfarge */
            cursor: crosshair;
            display: block;
        }

        /* Modal (Popup) Styles */
        #math-modal {
            display: none; /* Skjult som standard */
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            color: #333;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            z-index: 100;
            width: 300px;
        }

        #math-modal h2 { margin-top: 0; color: #2980b9; }
        #math-question { font-size: 2rem; font-weight: bold; margin: 20px 0; }
        
        input[type="number"] {
            padding: 10px;
            font-size: 1.2rem;
            width: 80%;
            margin-bottom: 20px;
            border: 2px solid #bdc3c7;
            border-radius: 5px;
            text-align: center;
        }

        button {
            background-color: #27ae60;
            color: white;
            border: none;
            padding: 10px 20px;
            font-size: 1.1rem;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.2s;
        }
        button:hover { background-color: #219150; }

        #game-over {
            display: none;
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85);
            color: white;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            z-index: 200;
        }
        #game-over h1 { font-size: 4rem; color: #e74c3c; margin-bottom: 10px; }
    </style>
</head>
<body>

    <div id="ui-bar">
        <span>仇벒잺 Liv: <span id="lives-display">10</span></span>
        <span>游깱 B칮lge: <span id="wave-display">1</span></span>
        <span>游끥 Poeng: <span id="score-display">0</span></span>
    </div>

    <div id="game-container">
        <canvas id="gameCanvas" width="800" height="600"></canvas>
        
        <div id="math-modal">
            <h2>L칮s oppgaven for 친 bygge!</h2>
            <div id="math-question">5 + 3 = ?</div>
            <input type="number" id="math-answer" placeholder="Ditt svar...">
            <br>
            <button onclick="checkAnswer()">Bygg T친rn!</button>
        </div>

        <div id="game-over">
            <h1>GAME OVER</h1>
            <p>Poengsum: <span id="final-score">0</span></p>
            <button onclick="location.reload()">Pr칮v Igjen</button>
        </div>
    </div>

<script>
    // --- KONFIGURASJON ---
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    
    // Spilltilstand
    let lives = 10;
    let score = 0;
    let wave = 1;
    let gameActive = true;
    let frameCount = 0;

    // Lister
    const towers = [];
    const enemies = [];
    const projectiles = [];

    // Stien fiendene f칮lger (x, y koordinater)
    const path = [
        {x: 0, y: 100}, {x: 200, y: 100}, {x: 200, y: 400}, 
        {x: 600, y: 400}, {x: 600, y: 200}, {x: 400, y: 200}, 
        {x: 400, y: 100}, {x: 700, y: 100}, {x: 700, y: 500}, 
        {x: 800, y: 500}
    ];

    // Variabler for matte-sp칮rsm친l
    let pendingTowerPos = null; // Hvor pr칮vde spilleren 친 bygge?
    let currentCorrectAnswer = 0;

    // --- KLASSER ---

    class Enemy {
        constructor() {
            this.pathIndex = 0;
            this.x = path[0].x;
            this.y = path[0].y;
            this.speed = 1 + (wave * 0.1); // Fiender blir raskere per b칮lge
            this.radius = 15;
            this.health = 20 + (wave * 5); // Fiender f친r mer liv per b칮lge
            this.maxHealth = this.health;
        }

        update() {
            // Finn neste punkt p친 stien
            let target = path[this.pathIndex + 1];
            if (!target) return; // N친dde slutten (h친ndteres i main loop)

            // Bevegelse
            let dx = target.x - this.x;
            let dy = target.y - this.y;
            let dist = Math.sqrt(dx*dx + dy*dy);

            if (dist < this.speed) {
                this.x = target.x;
                this.y = target.y;
                this.pathIndex++;
            } else {
                this.x += (dx / dist) * this.speed;
                this.y += (dy / dist) * this.speed;
            }
        }

        draw() {
            ctx.fillStyle = '#e74c3c';
            ctx.beginPath();
            ctx.arc(this.x, this.y, this.radius, 0, Math.PI*2);
            ctx.fill();
            
            // Helsebar
            ctx.fillStyle = 'red';
            ctx.fillRect(this.x - 15, this.y - 25, 30, 5);
            ctx.fillStyle = '#2ecc71';
            ctx.fillRect(this.x - 15, this.y - 25, 30 * (this.health / this.maxHealth), 5);
        }
    }

    class Tower {
        constructor(x, y) {
            this.x = x;
            this.y = y;
            this.range = 150;
            this.cooldown = 0;
            this.fireRate = 40; // Frames mellom hvert skudd
        }

        update() {
            if (this.cooldown > 0) this.cooldown--;

            // Finn n칝rmeste fiende
            if (this.cooldown <= 0) {
                let target = null;
                let minDst = Infinity;

                for (let enemy of enemies) {
                    let dist = Math.hypot(enemy.x - this.x, enemy.y - this.y);
                    if (dist < this.range && dist < minDst) {
                        minDst = dist;
                        target = enemy;
                    }
                }

                if (target) {
                    projectiles.push(new Projectile(this.x, this.y, target));
                    this.cooldown = this.fireRate;
                }
            }
        }

        draw() {
            ctx.fillStyle = '#3498db';
            ctx.fillRect(this.x - 20, this.y - 20, 40, 40);
            
            // T친rn "tak"
            ctx.fillStyle = '#2980b9';
            ctx.beginPath();
            ctx.moveTo(this.x, this.y - 20);
            ctx.lineTo(this.x + 20, this.y + 20);
            ctx.lineTo(this.x - 20, this.y + 20);
            ctx.fill();
        }
    }

    class Projectile {
        constructor(x, y, target) {
            this.x = x;
            this.y = y;
            this.target = target;
            this.speed = 8;
            this.active = true;
        }

        update() {
            if (!this.active) return;

            let dx = this.target.x - this.x;
            let dy = this.target.y - this.y;
            let dist = Math.hypot(dx, dy);

            if (dist < this.speed) {
                this.x = this.target.x;
                this.y = this.target.y;
                this.hit();
            } else {
                this.x += (dx/dist) * this.speed;
                this.y += (dy/dist) * this.speed;
            }
        }

        hit() {
            this.active = false;
            this.target.health -= 10;
            if (this.target.health <= 0 && enemies.includes(this.target)) {
                // Fiende d칮d
                enemies.splice(enemies.indexOf(this.target), 1);
                score += 10;
                document.getElementById('score-display').innerText = score;
            }
        }

        draw() {
            ctx.fillStyle = '#f1c40f';
            ctx.beginPath();
            ctx.arc(this.x, this.y, 5, 0, Math.PI*2);
            ctx.fill();
        }
    }

    // --- HOVEDLOGIKK ---

    function gameLoop() {
        if (!gameActive) return;

        ctx.clearRect(0, 0, canvas.width, canvas.height);
        drawMap();

        // Spawn fiender
        frameCount++;
        if (frameCount % (120 - wave * 5) === 0) { // Oftere spawn i h칮yere b칮lger
            enemies.push(new Enemy());
        }
        
        // 칒k vanskelighetsgrad (B칮lge) over tid
        if (frameCount % 1000 === 0) {
            wave++;
            document.getElementById('wave-display').innerText = wave;
        }

        // Oppdater og tegn objekter
        towers.forEach(t => { t.update(); t.draw(); });
        
        for (let i = projectiles.length - 1; i >= 0; i--) {
            projectiles[i].update();
            projectiles[i].draw();
            if (!projectiles[i].active) projectiles.splice(i, 1);
        }

        for (let i = enemies.length - 1; i >= 0; i--) {
            enemies[i].update();
            enemies[i].draw();
            
            // Sjekk om fiende n친dde slutten
            if (enemies[i].pathIndex >= path.length - 1) {
                lives--;
                document.getElementById('lives-display').innerText = lives;
                enemies.splice(i, 1);
                
                if (lives <= 0) endGame();
            }
        }

        requestAnimationFrame(gameLoop);
    }

    function drawMap() {
        // Tegn stien
        ctx.strokeStyle = '#7f8c8d';
        ctx.lineWidth = 40;
        ctx.lineCap = 'round';
        ctx.lineJoin = 'round';
        
        ctx.beginPath();
        ctx.moveTo(path[0].x, path[0].y);
        for (let i = 1; i < path.length; i++) {
            ctx.lineTo(path[i].x, path[i].y);
        }
        ctx.stroke();

        // Tegn "Basen"
        ctx.fillStyle = '#8e44ad';
        let end = path[path.length-1];
        ctx.beginPath();
        ctx.arc(end.x, end.y, 30, 0, Math.PI*2);
        ctx.fill();
        ctx.fillStyle = 'white';
        ctx.font = '16px Arial';
        ctx.fillText("BASE", end.x - 20, end.y + 5);
    }

    function endGame() {
        gameActive = false;
        document.getElementById('game-over').style.display = 'flex';
        document.getElementById('final-score').innerText = score;
    }

    // --- INTERAKSJON ---

    canvas.addEventListener('mousedown', function(e) {
        if (!gameActive) return;

        const rect = canvas.getBoundingClientRect();
        const mouseX = e.clientX - rect.left;
        const mouseY = e.clientY - rect.top;

        // Enkel sjekk for 친 ikke bygge p친 veien (tiln칝rmet)
        // (Her kan man legge inn mer avansert kollisjonssjekk)
        
        // 칀pne matte-modal
        pendingTowerPos = {x: mouseX, y: mouseY};
        openMathQuestion();
    });

    function openMathQuestion() {
        gameActive = false; // Pause spillet
        const modal = document.getElementById('math-modal');
        const qText = document.getElementById('math-question');
        const input = document.getElementById('math-answer');

        // Generer tilfeldig sp칮rsm친l (1-10)
        let n1 = Math.floor(Math.random() * 10) + 1;
        let n2 = Math.floor(Math.random() * 10) + 1;
        
        // Tilfeldig operasjon (+ eller -)
        if (Math.random() > 0.5) {
            currentCorrectAnswer = n1 + n2;
            qText.innerText = `${n1} + ${n2} = ?`;
        } else {
            // Unng친 negative tall for enkelhets skyld
            if (n1 < n2) [n1, n2] = [n2, n1];
            currentCorrectAnswer = n1 - n2;
            qText.innerText = `${n1} - ${n2} = ?`;
        }

        input.value = '';
        modal.style.display = 'block';
        input.focus();
    }

    function checkAnswer() {
        const input = document.getElementById('math-answer');
        const val = parseInt(input.value);

        if (val === currentCorrectAnswer) {
            // Riktig svar!
            towers.push(new Tower(pendingTowerPos.x, pendingTowerPos.y));
            closeModal();
        } else {
            // Feil svar!
            alert("Feil svar! T친rnet ble ikke bygget.");
            closeModal();
        }
    }

    function closeModal() {
        document.getElementById('math-modal').style.display = 'none';
        gameActive = true;
        gameLoop(); // Start loopen igjen
    }
    
    // Gj칮r at "Enter" fungerer i input-feltet
    document.getElementById('math-answer').addEventListener("keypress", function(event) {
        if (event.key === "Enter") {
            checkAnswer();
        }
    });

    // Start spillet
    gameLoop();

</script>
</body>
</html>
